{
  "name": "taskaya",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@clerk/clerk-react": "^5.59.2",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-slot": "^1.2.4",
    "@tailwindcss/vite": "^4.1.18",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.562.0",
    "react": "^19.2.3",
    "react-dom": "^19.2.3",
    "react-hook-form": "^7.69.0",
    "react-router": "^7.11.0",
    "react-router-dom": "^7.11.0",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "^4.1.18",
    "zod": "^4.2.1",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.4",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "tw-animate-css": "^1.4.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  },
  "description": "This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.",
  "main": "eslint.config.js",
  "keywords": [],
  "author": "",
  "license": "ISC"
}



// src/main.tsx - FIXED: Removed BrowserRouter wrapper
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { ClerkProvider } from "@clerk/clerk-react";
import App from "./App";
import "./index.css";

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <ClerkProvider
      publishableKey={import.meta.env.VITE_CLERK_PUBLISHABLE_KEY}
      afterSignInUrl="/"
      afterSignUpUrl="/"
      signInUrl="/sign-in"
      signUpUrl="/sign-up"
    >
      <App />
    </ClerkProvider>
  </StrictMode>
);





/* // src/index.css */
@import "tailwindcss";
@import "tw-animate-css";
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Poppins:wght@400;500;600;700;800;900&display=swap');

@custom-variant dark (&:is(.dark *));

@theme inline {
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

:root {
  --radius: 0.75rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* Animations */
@keyframes wave {
  0%, 100% { 
    transform: translateY(0px);
    opacity: 1;
  }
  50% { 
    transform: translateY(-10px);
    opacity: 0.7;
  }
}

.animate-wave {
  animation: wave 3s ease-in-out infinite;
}

@keyframes gradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.animate-gradient {
  animation: gradient 3s ease infinite;
  background-size: 200% auto;
}

.page-transition {
  animation-duration: 0.3s;
  animation-fill-mode: both;
}

.page-transition.fadeOut {
  animation-name: fadeOut;
}

.page-transition.fadeIn {
  animation-name: fadeIn;
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-10px);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ============================================================
   SMOOTH SCROLLING
============================================================ */
* {
  scroll-behavior: smooth;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: hsl(var(--background));
}

::-webkit-scrollbar-thumb {
  background: hsl(var(--muted-foreground) / 0.3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: hsl(var(--muted-foreground) / 0.5);
}

/* ============================================================
   LOADING STATES
============================================================ */
.skeleton {
  animation: skeleton-loading 1.5s infinite ease-in-out;
  background: linear-gradient(
    90deg,
    hsl(var(--muted)) 0%,
    hsl(var(--muted-foreground) / 0.1) 50%,
    hsl(var(--muted)) 100%
  );
  background-size: 200% 100%;
}

@keyframes skeleton-loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

/* ============================================================
   FOCUS VISIBLE IMPROVEMENTS
============================================================ */
*:focus-visible {
  outline: 2px solid hsl(var(--primary));
  outline-offset: 2px;
  border-radius: 4px;
}

/* ============================================================
   PERFORMANCE OPTIMIZATIONS
============================================================ */
.will-change-transform {
  will-change: transform;
}

.will-change-opacity {
  will-change: opacity;
}

/* ============================================================
   ACCESSIBILITY IMPROVEMENTS
============================================================ */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Reduce motion for users who prefer it */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}



// src/AuthRoute.tsx
import { useState } from 'react';
import { Login } from '@/components/Login';
import { Register } from '@/components/Register';

export function AuthRoute() {
  const [isLogin, setIsLogin] = useState(true);

  return isLogin ? (
    <Login onSwitchToRegister={() => setIsLogin(false)} />
  ) : (
    <Register onSwitchToLogin={() => setIsLogin(true)} />
  );
}




// src/App.tsx
import { useEffect } from "react";
import { BrowserRouter } from "react-router-dom";
import { useAuth } from "@clerk/clerk-react";
import { Loader2 } from "lucide-react";

import { useAuthStore } from "./store";
import { AppRouter } from "./router";
import { ThemeProvider } from "./components/theme-provider";
import { ErrorBoundary } from "./components/ErrorBoundary";

function App() {
  const { isLoaded: clerkLoaded } = useAuth();
  const { initializeAuth } = useAuthStore();

  // Initialize JWT auth on mount
  useEffect(() => {
    initializeAuth();
  }, [initializeAuth]);

  // Show loading screen while Clerk initializes
  if (!clerkLoaded) {
    return (
      <ThemeProvider defaultTheme="system" storageKey="taskaya-theme">
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-primary/5 to-purple-500/10">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-primary to-purple-500 mb-6 animate-pulse shadow-2xl shadow-primary/30">
              <span className="text-4xl">üìù</span>
            </div>
            <Loader2 className="w-8 h-8 animate-spin text-primary mx-auto mb-4" />
            <p className="text-muted-foreground font-bold">
              Loading Taskaya...
            </p>
          </div>
        </div>
      </ThemeProvider>
    );
  }

  return (
    <ErrorBoundary>
      <ThemeProvider defaultTheme="system" storageKey="taskaya-theme">
        <AppRouter />
      </ThemeProvider>
    </ErrorBoundary>
  );
}

export default App;





// src/store/index.ts - OPTIMIZED: Lazy task loading after auth
import { create } from "zustand";
import { persist } from "zustand/middleware";

interface User {
  id: number;
  email: string;
}

export interface Task {
  id: number;
  userId: number;
  title: string;
  description: string | null;
  status: string;
  deadline: string | null;
  isUrgent: boolean;
  completed: boolean;
  createdAt: string;
  updatedAt: string;
  created_at: string;
  updated_at: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
  login: (email: string, password: string) => Promise<void>;
  register: (email: string, password: string) => Promise<void>;
  logout: () => Promise<void>;
  refreshAccessToken: () => Promise<boolean>;
  clearError: () => void;
  initializeAuth: () => void;
}

interface TaskState {
  tasks: Task[];
  allTasks: Task[];
  completedTasks: Task[];
  urgentTasks: Task[];
  isLoading: boolean;
  error: string | null;
  lastFetch: number;
  lastCompletedFetch: number;
  lastUrgentFetch: number;
  searchQuery: string;
  currentView: "all" | "completed" | "urgent";
  pendingRequests: Set<string>;

  fetchTasks: (token: string, force?: boolean) => Promise<void>;
  addTask: (
    token: string,
    title: string,
    description?: string,
    deadline?: string,
    isUrgent?: boolean
  ) => Promise<void>;
  updateTask: (token: string, id: number, data: Partial<Task>) => Promise<void>;
  deleteTask: (token: string, id: number) => Promise<void>;
  completeTask: (token: string, id: number) => Promise<void>;
  filterTasks: (query: string) => void;
  setViewTasks: (view: "all" | "completed" | "urgent") => void;
  setCurrentView: (view: "all" | "completed" | "urgent") => void;
  clearError: () => void;
  resetTasks: () => void;
  getCompletedTasks: (token: string) => Promise<void>;
  getUrgentTasks: (token: string) => Promise<void>;
}

const API_URL = "http://localhost:5000/api";
const CACHE_TIME = 5000; // 5 seconds

const fetchAPI = async (
  url: string,
  token: string,
  options: RequestInit = {}
) => {
  const response = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
      ...options.headers,
    },
  });

  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error || `Request failed: ${response.status}`);
  }

  return data;
};

const fetchAPINoAuth = async (url: string, options: RequestInit = {}) => {
  const response = await fetch(url, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      ...options.headers,
    },
  });

  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error || `Request failed: ${response.status}`);
  }

  return data;
};

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      refreshToken: null,
      isAuthenticated: false,
      isLoading: false,
      error: null,

      initializeAuth: () => {
        const { token, user } = get();
        if (token && user) {
          set({ isAuthenticated: true });
        } else {
          set({ isAuthenticated: false });
        }
      },

      // OPTIMIZED: Faster login without unnecessary operations
      login: async (email: string, password: string) => {
        set({ isLoading: true, error: null });
        try {
          const data = await fetchAPINoAuth(`${API_URL}/auth/login`, {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          // Set auth state immediately
          set({
            user: data.user,
            token: data.accessToken,
            refreshToken: data.refreshToken,
            isAuthenticated: true,
            isLoading: false,
            error: null,
          });

          // Note: Tasks will be loaded lazily by components, not here
        } catch (error) {
          const message =
            error instanceof Error ? error.message : "Login failed";
          set({ error: message, isLoading: false });
          throw error;
        }
      },

      // OPTIMIZED: Faster register without unnecessary operations
      register: async (email: string, password: string) => {
        set({ isLoading: true, error: null });
        try {
          const data = await fetchAPINoAuth(`${API_URL}/auth/register`, {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          // Set auth state immediately
          set({
            user: data.user,
            token: data.accessToken,
            refreshToken: data.refreshToken,
            isAuthenticated: true,
            isLoading: false,
            error: null,
          });

          // Note: Tasks will be loaded lazily by components, not here
        } catch (error) {
          const message =
            error instanceof Error ? error.message : "Registration failed";
          set({ error: message, isLoading: false });
          throw error;
        }
      },

      refreshAccessToken: async () => {
        const { refreshToken } = get();

        if (!refreshToken) {
          set({
            user: null,
            token: null,
            refreshToken: null,
            isAuthenticated: false,
          });
          return false;
        }

        try {
          const data = await fetchAPINoAuth(`${API_URL}/auth/refresh`, {
            method: "POST",
            body: JSON.stringify({ refreshToken }),
          });

          set({
            token: data.accessToken,
            refreshToken: data.refreshToken,
            isAuthenticated: true,
          });

          return true;
        } catch (error) {
          set({
            user: null,
            token: null,
            refreshToken: null,
            isAuthenticated: false,
            error: "Session expired. Please login again.",
          });

          return false;
        }
      },

      logout: async () => {
        const { refreshToken } = get();

        if (refreshToken) {
          try {
            await fetchAPINoAuth(`${API_URL}/auth/logout`, {
              method: "POST",
              body: JSON.stringify({ refreshToken }),
            });
          } catch (error) {
            console.error("Logout request failed:", error);
          }
        }

        set({
          user: null,
          token: null,
          refreshToken: null,
          isAuthenticated: false,
          error: null,
        });

        useTaskStore.getState().resetTasks();
      },

      clearError: () => set({ error: null }),
    }),
    {
      name: "auth-storage",
      partialize: (state) => ({
        user: state.user,
        token: state.token,
        refreshToken: state.refreshToken,
      }),
    }
  )
);

export const useTaskStore = create<TaskState>()((set, get) => ({
  tasks: [],
  allTasks: [],
  completedTasks: [],
  urgentTasks: [],
  isLoading: false,
  error: null,
  lastFetch: 0,
  lastCompletedFetch: 0,
  lastUrgentFetch: 0,
  searchQuery: "",
  currentView: "all",
  pendingRequests: new Set(),

  setCurrentView: (view) => {
    set({ currentView: view });
    get().setViewTasks(view);
  },

  setViewTasks: (view: "all" | "completed" | "urgent") => {
    const { allTasks, completedTasks, urgentTasks } = get();
    let filtered: Task[];

    switch (view) {
      case "completed":
        filtered = completedTasks;
        break;
      case "urgent":
        filtered = urgentTasks;
        break;
      case "all":
      default:
        filtered = allTasks;
        break;
    }

    set({ tasks: filtered, currentView: view });
  },

  fetchTasks: async (token: string, force = false) => {
    if (!token) {
      set({ error: "Please login to view tasks" });
      return;
    }

    const requestKey = "fetch-all-tasks";
    const { pendingRequests, lastFetch, allTasks } = get();

    if (pendingRequests.has(requestKey)) {
      console.log("‚è∏Ô∏è Request already pending, skipping...");
      return;
    }

    const now = Date.now();

    if (!force && now - lastFetch < CACHE_TIME && allTasks.length > 0) {
      console.log("‚úÖ Using cached all tasks");
      return;
    }

    pendingRequests.add(requestKey);
    set({
      isLoading: true,
      error: null,
      pendingRequests: new Set(pendingRequests),
    });

    try {
      const [pendingData, completedData, urgentData] = await Promise.all([
        fetchAPI(`${API_URL}/tasks`, token),
        fetchAPI(`${API_URL}/tasks/completed`, token),
        fetchAPI(`${API_URL}/tasks/urgent`, token),
      ]);

      const allTasksMap = new Map<number, Task>();

      [
        ...pendingData.tasks,
        ...completedData.tasks,
        ...urgentData.tasks,
      ].forEach((task) => {
        allTasksMap.set(task.id, task);
      });

      const combinedTasks = Array.from(allTasksMap.values());

      console.log(`‚úÖ Combined all tasks: ${combinedTasks.length} total`);

      pendingRequests.delete(requestKey);
      set({
        tasks: combinedTasks,
        allTasks: combinedTasks,
        isLoading: false,
        lastFetch: now,
        searchQuery: "",
        pendingRequests: new Set(pendingRequests),
      });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to fetch tasks";
      pendingRequests.delete(requestKey);
      set({
        error: message,
        isLoading: false,
        pendingRequests: new Set(pendingRequests),
      });
    }
  },

  getCompletedTasks: async (token: string) => {
    if (!token) {
      set({ error: "Please login to view tasks" });
      return;
    }

    const requestKey = "fetch-completed-tasks";
    const { pendingRequests, lastCompletedFetch, completedTasks } = get();

    if (pendingRequests.has(requestKey)) {
      console.log("‚è∏Ô∏è Completed tasks request already pending, skipping...");
      return;
    }

    const now = Date.now();

    if (now - lastCompletedFetch < CACHE_TIME && completedTasks.length > 0) {
      console.log("‚úÖ Using cached completed tasks");
      set({ tasks: completedTasks, currentView: "completed" });
      return;
    }

    pendingRequests.add(requestKey);
    set({
      isLoading: true,
      error: null,
      pendingRequests: new Set(pendingRequests),
    });

    try {
      const data = await fetchAPI(`${API_URL}/tasks/completed`, token);

      pendingRequests.delete(requestKey);
      set({
        tasks: data.tasks,
        completedTasks: data.tasks,
        isLoading: false,
        lastCompletedFetch: now,
        currentView: "completed",
        pendingRequests: new Set(pendingRequests),
      });
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : "Failed to fetch completed tasks";
      pendingRequests.delete(requestKey);
      set({
        error: message,
        isLoading: false,
        pendingRequests: new Set(pendingRequests),
      });
    }
  },

  getUrgentTasks: async (token: string) => {
    if (!token) {
      set({ error: "Please login to view tasks" });
      return;
    }

    const requestKey = "fetch-urgent-tasks";
    const { pendingRequests, lastUrgentFetch, urgentTasks } = get();

    if (pendingRequests.has(requestKey)) {
      console.log("‚è∏Ô∏è Urgent tasks request already pending, skipping...");
      return;
    }

    const now = Date.now();

    if (now - lastUrgentFetch < CACHE_TIME && urgentTasks.length > 0) {
      console.log("‚úÖ Using cached urgent tasks");
      set({ tasks: urgentTasks, currentView: "urgent" });
      return;
    }

    pendingRequests.add(requestKey);
    set({
      isLoading: true,
      error: null,
      pendingRequests: new Set(pendingRequests),
    });

    try {
      const data = await fetchAPI(`${API_URL}/tasks/urgent`, token);

      pendingRequests.delete(requestKey);
      set({
        tasks: data.tasks,
        urgentTasks: data.tasks,
        isLoading: false,
        lastUrgentFetch: now,
        currentView: "urgent",
        pendingRequests: new Set(pendingRequests),
      });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to fetch urgent tasks";
      pendingRequests.delete(requestKey);
      set({
        error: message,
        isLoading: false,
        pendingRequests: new Set(pendingRequests),
      });
    }
  },

  filterTasks: (query: string) => {
    const { allTasks } = get();

    if (!query.trim()) {
      set({ tasks: allTasks, searchQuery: "" });
      return;
    }

    const trimmedQuery = query.trim().toLowerCase();
    const filtered = allTasks.filter((task) => {
      const titleMatch = task.title.toLowerCase().includes(trimmedQuery);
      const descriptionMatch = task.description
        ?.toLowerCase()
        .includes(trimmedQuery);
      return titleMatch || descriptionMatch;
    });

    set({ tasks: filtered, searchQuery: query });
  },

  addTask: async (token, title, description, deadline, isUrgent) => {
    if (!token) {
      set({ error: "Please login to add tasks" });
      throw new Error("Please login to add tasks");
    }

    if (!title || !title.trim()) {
      set({ error: "Task title is required" });
      throw new Error("Task title is required");
    }

    set({ isLoading: true, error: null });
    try {
      await fetchAPI(`${API_URL}/tasks`, token, {
        method: "POST",
        body: JSON.stringify({
          title: title.trim(),
          description: description?.trim() || undefined,
          deadline,
          is_urgent: isUrgent || false,
        }),
      });

      await get().fetchTasks(token, true);
      const { currentView } = get();
      get().setViewTasks(currentView);

      set({ isLoading: false });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to add task";
      set({ error: message, isLoading: false });
      throw error;
    }
  },

  updateTask: async (token, id, taskData) => {
    if (!token) {
      set({ error: "Please login to update tasks" });
      throw new Error("Please login to update tasks");
    }

    const { tasks, allTasks, completedTasks, urgentTasks, currentView } = get();

    const updateTaskInArray = (arr: Task[]) =>
      arr.map((t) => (t.id === id ? { ...t, ...taskData } : t));

    set({
      tasks: updateTaskInArray(tasks),
      allTasks: updateTaskInArray(allTasks),
      completedTasks: updateTaskInArray(completedTasks),
      urgentTasks: updateTaskInArray(urgentTasks),
    });

    try {
      const backendData: any = {};
      if (taskData.title !== undefined) backendData.title = taskData.title;
      if (taskData.description !== undefined)
        backendData.description = taskData.description;
      if (taskData.deadline !== undefined)
        backendData.deadline = taskData.deadline;
      if (taskData.isUrgent !== undefined)
        backendData.is_urgent = taskData.isUrgent;
      if (taskData.completed !== undefined)
        backendData.completed = taskData.completed;
      if (taskData.status !== undefined) backendData.status = taskData.status;

      await fetchAPI(`${API_URL}/tasks/${id}`, token, {
        method: "PUT",
        body: JSON.stringify(backendData),
      });

      set({
        lastFetch: 0,
        lastCompletedFetch: 0,
        lastUrgentFetch: 0,
      });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to update task";
      set({ error: message });

      if (currentView === "completed") {
        await get().getCompletedTasks(token);
      } else if (currentView === "urgent") {
        await get().getUrgentTasks(token);
      } else {
        await get().fetchTasks(token, true);
      }

      throw error;
    }
  },

  deleteTask: async (token, id) => {
    if (!token) {
      set({ error: "Please login to delete tasks" });
      throw new Error("Please login to delete tasks");
    }

    const { tasks, allTasks, completedTasks, urgentTasks, currentView } = get();

    const removeTaskFromArray = (arr: Task[]) => arr.filter((t) => t.id !== id);

    set({
      tasks: removeTaskFromArray(tasks),
      allTasks: removeTaskFromArray(allTasks),
      completedTasks: removeTaskFromArray(completedTasks),
      urgentTasks: removeTaskFromArray(urgentTasks),
    });

    try {
      await fetchAPI(`${API_URL}/tasks/${id}`, token, {
        method: "DELETE",
      });

      set({
        lastFetch: 0,
        lastCompletedFetch: 0,
        lastUrgentFetch: 0,
      });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to delete task";
      set({ error: message });

      if (currentView === "completed") {
        await get().getCompletedTasks(token);
      } else if (currentView === "urgent") {
        await get().getUrgentTasks(token);
      } else {
        await get().fetchTasks(token, true);
      }

      throw error;
    }
  },

  completeTask: async (token, id) => {
    if (!token) {
      set({ error: "Please login to complete tasks" });
      throw new Error("Please login to complete tasks");
    }

    const { tasks, allTasks, completedTasks, urgentTasks, currentView } = get();

    const updateTaskInArray = (arr: Task[]) =>
      arr.map((t) => (t.id === id ? { ...t, completed: true } : t));

    set({
      tasks: updateTaskInArray(tasks),
      allTasks: updateTaskInArray(allTasks),
      completedTasks: updateTaskInArray(completedTasks),
      urgentTasks: updateTaskInArray(urgentTasks),
    });

    try {
      await fetchAPI(`${API_URL}/tasks/${id}`, token, {
        method: "PUT",
        body: JSON.stringify({ completed: true }),
      });

      set({
        lastFetch: 0,
        lastCompletedFetch: 0,
        lastUrgentFetch: 0,
      });
    } catch (error) {
      const message =
        error instanceof Error ? error.message : "Failed to complete task";
      set({ error: message });

      if (currentView === "completed") {
        await get().getCompletedTasks(token);
      } else if (currentView === "urgent") {
        await get().getUrgentTasks(token);
      } else {
        await get().fetchTasks(token, true);
      }

      throw error;
    }
  },

  clearError: () => set({ error: null }),

  resetTasks: () => {
    set({
      tasks: [],
      allTasks: [],
      completedTasks: [],
      urgentTasks: [],
      isLoading: false,
      error: null,
      lastFetch: 0,
      lastCompletedFetch: 0,
      lastUrgentFetch: 0,
      searchQuery: "",
      currentView: "all",
      pendingRequests: new Set(),
    });
  },
}));




// src/router/index.tsx - FIXED: Auth method context
import {
  createBrowserRouter,
  RouterProvider,
  Navigate,
} from "react-router-dom";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore } from "@/store";
import { MainLayout } from "@/components/layouts/MainLayout";
import { AuthMethodSelector } from "@/components/AuthMethodSelector";
import { Login } from "@/components/Login";
import { Register } from "@/components/Register";
import { SSOCallback } from "@/components/SSOCallback";
import { Main } from "@/components/Main";
import { Completed } from "@/components/Completed";
import { Urgent } from "@/components/Urgent";
import { Loader2 } from "lucide-react";

/* ----------------------------------
   Loading Screen
-----------------------------------*/
function LoadingScreen() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <Loader2 className="w-8 h-8 animate-spin text-primary" />
    </div>
  );
}

/* ----------------------------------
   Auth Method Hook (SAFE)
-----------------------------------*/
export function useAuthMethod(): "clerk" | "jwt" | null {
  const { isSignedIn, isLoaded } = useAuth();
  const { isAuthenticated, token } = useAuthStore();

  console.log("üîç useAuthMethod Debug:", {
    clerkLoaded: isLoaded,
    clerkSignedIn: isSignedIn,
    jwtAuthenticated: isAuthenticated,
    hasJWTToken: !!token,
  });

  if (!isLoaded) {
    console.log("‚è≥ Clerk not loaded yet");
    return null;
  }

  if (isSignedIn) {
    console.log("‚úÖ Auth Method: CLERK");
    return "clerk";
  }

  if (isAuthenticated && token) {
    console.log("‚úÖ Auth Method: JWT");
    return "jwt";
  }

  console.log("‚ùå No authentication found");
  return null;
}

/* ----------------------------------
   Protected Route
-----------------------------------*/
function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const { isLoaded, isSignedIn } = useAuth();
  const { isAuthenticated } = useAuthStore();

  if (!isLoaded) return <LoadingScreen />;

  if (!isSignedIn && !isAuthenticated) {
    return <Navigate to="/auth" replace />;
  }

  return <>{children}</>;
}

/* ----------------------------------
   Auth Route
-----------------------------------*/
function AuthRoute({ children }: { children: React.ReactNode }) {
  const { isLoaded, isSignedIn } = useAuth();
  const { isAuthenticated } = useAuthStore();

  if (!isLoaded) return <LoadingScreen />;

  if (isSignedIn || isAuthenticated) {
    return <Navigate to="/" replace />;
  }

  return <>{children}</>;
}

/* ----------------------------------
   Protected Layout with Auth Context
-----------------------------------*/
function ProtectedLayout() {
  const authMethod = useAuthMethod();

  console.log("üîê ProtectedLayout - Auth Method:", authMethod);

  return (
    <ProtectedRoute>
      <MainLayout authMethod={authMethod} />
    </ProtectedRoute>
  );
}

/* ----------------------------------
   Router
-----------------------------------*/
export const router = createBrowserRouter([
  {
    path: "/",
    element: <ProtectedLayout />,
    children: [
      { index: true, element: <Main /> },
      { path: "completed", element: <Completed /> },
      { path: "urgent", element: <Urgent /> },
    ],
  },
  {
    path: "/auth",
    element: (
      <AuthRoute>
        <AuthMethodSelector
          onSelectJWT={() => (window.location.href = "/auth/login")}
          onSelectClerk="clerk"
        />
      </AuthRoute>
    ),
  },
  {
    path: "/auth/login",
    element: (
      <AuthRoute>
        <Login
          onSwitchToRegister={() => (window.location.href = "/auth/register")}
          onBack={() => (window.location.href = "/auth")}
        />
      </AuthRoute>
    ),
  },
  {
    path: "/auth/register",
    element: (
      <AuthRoute>
        <Register
          onSwitchToLogin={() => (window.location.href = "/auth/login")}
          onBack={() => (window.location.href = "/auth")}
        />
      </AuthRoute>
    ),
  },
  {
    path: "/sso-callback",
    element: <SSOCallback />,
  },
  {
    path: "*",
    element: <Navigate to="/" replace />,
  },
]);

/* ----------------------------------
   Router Provider
-----------------------------------*/
export function AppRouter() {
  return <RouterProvider router={router} />;
}





// frontend/src/lib/validations.ts
import { z } from "zod";

// Auth Schemas - UPDATED: Removed Gmail-only restriction
export const loginSchema = z.object({
  email: z.string().min(1, "Email is required").email("Invalid email address"),
  password: z
    .string()
    .min(6, "Password must be at least 6 characters")
    .max(100, "Password is too long"),
});

export const registerSchema = loginSchema
  .extend({
    confirmPassword: z.string().min(6, "Confirm password is required"),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
  });

// Task Schemas
export const taskSchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(500, "Title is too long")
    .trim(),
  description: z
    .string()
    .max(2000, "Description is too long")
    .optional()
    .nullable(),
  deadline: z
    .string()
    .datetime("Invalid date format")
    .optional()
    .nullable()
    .or(z.literal("")),
  isUrgent: z.boolean().default(false),
});

export const updateTaskSchema = z.object({
  title: z.string().min(1, "Title is required").max(500).trim().optional(),
  description: z.string().max(2000).optional().nullable(),
  deadline: z
    .string()
    .datetime("Invalid date format")
    .optional()
    .nullable()
    .or(z.literal("")),
  isUrgent: z.boolean().optional(),
  completed: z.boolean().optional(),
  status: z.enum(["pending", "in_progress", "completed"]).optional(),
});

export const searchSchema = z.object({
  query: z.string().min(1, "Search query is required").max(200).trim(),
});

// Types
export type LoginInput = z.infer<typeof loginSchema>;
export type RegisterInput = z.infer<typeof registerSchema>;
export type TaskInput = z.infer<typeof taskSchema>;
export type UpdateTaskInput = z.infer<typeof updateTaskSchema>;
export type SearchInput = z.infer<typeof searchSchema>;





// src/lib/utils.ts
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}




// src/components/Urgent.tsx - UPDATED: Non-clickable emoji
import { useEffect, useState, useMemo, useCallback, memo } from "react";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore, useTaskStore } from "@/store";
import { useOutletContext } from "react-router-dom";
import type { Task } from "@/store";
import {
  AlertCircle,
  Circle,
  CheckCircle2,
  Trash2,
  Edit2,
  Calendar,
  Save,
  X,
  Clock,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { ConfirmDialog } from "./ConfirmDialog";
import { CustomDatePicker } from "./CustomDatePicker";

const UrgentTaskCard = memo(
  ({
    task,
    isEditing,
    onToggleComplete,
    onToggleUrgent,
    onStartEdit,
    onDelete,
    onSaveEdit,
    onCancelEdit,
    editData,
    onEditChange,
  }: {
    task: Task;
    isEditing: boolean;
    onToggleComplete: (id: number, status: boolean) => void;
    onToggleUrgent: (id: number, status: boolean) => void;
    onStartEdit: (task: Task) => void;
    onDelete: (id: number) => void;
    onSaveEdit: (id: number) => void;
    onCancelEdit: () => void;
    editData: {
      title: string;
      description: string;
      deadline: string;
      isUrgent: boolean;
    };
    onEditChange: (field: string, value: any) => void;
  }) => {
    return (
      <div
        className={cn(
          "group bg-gradient-to-br from-red-500/5 to-orange-500/5 border-2 border-red-500/30 rounded-2xl p-4 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1",
          task.completed && "opacity-60"
        )}
      >
        <div className="flex items-start gap-4">
          <button
            onClick={() => onToggleComplete(task.id, task.completed)}
            className="mt-1 flex-shrink-0 text-red-500 hover:text-green-500 transition-all hover:scale-125"
          >
            {task.completed ? (
              <CheckCircle2 className="w-6 h-6" />
            ) : (
              <Circle className="w-6 h-6" />
            )}
          </button>

          <div className="flex-1 min-w-0">
            {isEditing ? (
              <div className="space-y-3">
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => onEditChange("title", e.target.value)}
                  placeholder="Task title..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-red-500 focus:ring-2 focus:ring-red-500/20 outline-none font-bold"
                  autoFocus
                />
                <textarea
                  value={editData.description}
                  onChange={(e) => onEditChange("description", e.target.value)}
                  placeholder="Description (optional)..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-input focus:border-red-500 focus:ring-2 focus:ring-red-500/20 outline-none resize-none"
                  rows={2}
                />
                <CustomDatePicker
                  value={editData.deadline}
                  onChange={(val) => onEditChange("deadline", val)}
                />
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    onEditChange("isUrgent", !editData.isUrgent);
                  }}
                  className={`w-full px-4 py-2 rounded-lg font-bold transition-all ${
                    editData.isUrgent
                      ? "bg-red-500 text-white"
                      : "bg-secondary text-secondary-foreground"
                  }`}
                >
                  {editData.isUrgent ? "üî• Urgent" : "‚≠ê Normal"}
                </button>
                <div className="flex gap-2">
                  <button
                    onClick={() => onSaveEdit(task.id)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold hover:opacity-90 transition-all"
                  >
                    <Save className="w-4 h-4" />
                    Save
                  </button>
                  <button
                    onClick={onCancelEdit}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-secondary text-secondary-foreground font-bold hover:bg-secondary/80 transition-all"
                  >
                    <X className="w-4 h-4" />
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="flex items-start gap-2">
                  {/* UPDATED: Non-clickable urgent emoji */}
                  <span
                    className="text-2xl animate-pulse pointer-events-none select-none"
                    aria-label="Urgent task"
                    role="img"
                  >
                    üî•
                  </span>
                  {task.completed && (
                    <span
                      className="text-xl pointer-events-none select-none"
                      aria-label="Completed task"
                      role="img"
                    >
                      ‚úÖ
                    </span>
                  )}
                  <div className="flex-1">
                    <p
                      className={cn(
                        "text-foreground font-black text-xl",
                        task.completed && "line-through text-muted-foreground"
                      )}
                    >
                      {task.title}
                    </p>
                    {task.description && (
                      <p
                        className={cn(
                          "text-muted-foreground font-semibold text-sm mt-1",
                          task.completed && "line-through"
                        )}
                      >
                        {task.description}
                      </p>
                    )}
                    {task.deadline && (
                      <div className="flex items-center gap-2 mt-3">
                        <div className="px-3 py-1 rounded-lg bg-red-500/20 border border-red-500/30 flex items-center gap-2">
                          <Calendar className="w-4 h-4 text-red-500" />
                          <span className="text-sm font-bold text-red-500">
                            Due:{" "}
                            {new Date(task.deadline).toLocaleDateString(
                              "en-US",
                              {
                                month: "short",
                                day: "numeric",
                                year: "numeric",
                              }
                            )}
                          </span>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}
          </div>

          {!isEditing && (
            <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                onClick={() => onToggleComplete(task.id, task.completed)}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.completed
                    ? "text-green-500 hover:bg-green-500/10"
                    : "text-muted-foreground hover:text-green-500 hover:bg-green-500/10"
                }`}
                title={task.completed ? "Mark incomplete" : "Mark complete"}
              >
                <CheckCircle2 className="w-4 h-4" />
              </button>

              <button
                onClick={() => onToggleUrgent(task.id, task.isUrgent)}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.isUrgent
                    ? "text-red-500 hover:bg-red-500/10"
                    : "text-muted-foreground hover:text-red-500 hover:bg-red-500/10"
                }`}
                title={task.isUrgent ? "Remove urgent" : "Mark urgent"}
              >
                <AlertCircle
                  className={cn("w-4 h-4", task.isUrgent && "fill-red-500")}
                />
              </button>

              <button
                onClick={() => onStartEdit(task)}
                className="p-2 rounded-lg text-muted-foreground hover:text-red-500 hover:bg-red-500/10 transition-all hover:scale-110"
              >
                <Edit2 className="w-4 h-4" />
              </button>
              <button
                onClick={() => onDelete(task.id)}
                className="p-2 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all hover:scale-110"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }
);

UrgentTaskCard.displayName = "UrgentTaskCard";

type OutletContext = {
  authMethod: "clerk" | "jwt" | null;
};

export function Urgent({
  authMethod: propAuthMethod,
}: {
  authMethod?: "clerk" | "jwt" | null;
}) {
  const { getToken } = useAuth();
  const { token: jwtToken } = useAuthStore();
  const outletContext = useOutletContext<OutletContext>();

  const authMethod = propAuthMethod || outletContext?.authMethod || null;

  const { tasks, getUrgentTasks, updateTask, deleteTask, isLoading } =
    useTaskStore();
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editTitle, setEditTitle] = useState("");
  const [editDescription, setEditDescription] = useState("");
  const [editDeadline, setEditDeadline] = useState("");
  const [editIsUrgent, setEditIsUrgent] = useState(true);
  const [deleteConfirm, setDeleteConfirm] = useState<number | null>(null);

  useEffect(() => {
    const loadUrgentTasks = async () => {
      let token: string | null = null;

      if (authMethod === "clerk") {
        token = await getToken();
      } else if (authMethod === "jwt") {
        token = jwtToken;
      }

      if (token) {
        getUrgentTasks(token);
      }
    };
    loadUrgentTasks();
  }, [getUrgentTasks, getToken, authMethod, jwtToken]);

  const urgentTasks = useMemo(
    () => tasks.filter((t) => t.isUrgent === true),
    [tasks]
  );

  // Stats for cross-tab display
  const stats = useMemo(() => {
    const urgentActive = urgentTasks.filter((t) => !t.completed).length;
    const urgentCompleted = urgentTasks.filter((t) => t.completed).length;
    const urgentTotal = urgentTasks.length;

    return {
      urgentActive,
      urgentCompleted,
      urgentTotal,
    };
  }, [urgentTasks]);

  const getAuthToken = useCallback(async (): Promise<string | null> => {
    if (authMethod === "clerk") {
      return await getToken();
    } else if (authMethod === "jwt") {
      return jwtToken;
    }
    return null;
  }, [authMethod, getToken, jwtToken]);

  const handleToggleComplete = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        await updateTask(token, id, { completed: !currentStatus });
      }
    },
    [getAuthToken, updateTask]
  );

  const handleToggleUrgent = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        await updateTask(token, id, { isUrgent: !currentStatus });
      }
    },
    [getAuthToken, updateTask]
  );

  const handleDelete = useCallback(async () => {
    if (deleteConfirm) {
      const token = await getAuthToken();
      if (token) {
        await deleteTask(token, deleteConfirm);
        setDeleteConfirm(null);
      }
    }
  }, [deleteConfirm, getAuthToken, deleteTask]);

  const startEdit = useCallback((task: Task) => {
    setEditingId(task.id);
    setEditTitle(task.title);
    setEditDescription(task.description || "");
    setEditDeadline(task.deadline || "");
    setEditIsUrgent(task.isUrgent);
  }, []);

  const saveEdit = useCallback(
    async (id: number) => {
      if (editTitle.trim()) {
        const token = await getAuthToken();
        if (token) {
          await updateTask(token, id, {
            title: editTitle,
            description: editDescription || null,
            deadline: editDeadline || null,
            isUrgent: editIsUrgent,
          });
          setEditingId(null);
        }
      }
    },
    [
      editTitle,
      editDescription,
      editDeadline,
      editIsUrgent,
      getAuthToken,
      updateTask,
    ]
  );

  const cancelEdit = useCallback(() => {
    setEditingId(null);
    setEditTitle("");
    setEditDescription("");
    setEditDeadline("");
    setEditIsUrgent(true);
  }, []);

  const handleEditChange = useCallback((field: string, value: any) => {
    switch (field) {
      case "title":
        setEditTitle(value);
        break;
      case "description":
        setEditDescription(value);
        break;
      case "deadline":
        setEditDeadline(value);
        break;
      case "isUrgent":
        setEditIsUrgent(value);
        break;
    }
  }, []);

  const editData = useMemo(
    () => ({
      title: editTitle,
      description: editDescription,
      deadline: editDeadline,
      isUrgent: editIsUrgent,
    }),
    [editTitle, editDescription, editDeadline, editIsUrgent]
  );

  return (
    <div className="flex-1 p-6 space-y-6 overflow-auto">
      <div className="animate-in fade-in slide-in-from-top-4 duration-500">
        <div className="flex items-center gap-3 mb-4">
          <div className="p-4 rounded-2xl bg-gradient-to-br from-red-500 to-orange-500 shadow-lg shadow-red-500/25 animate-pulse">
            <AlertCircle className="w-8 h-8 text-white" />
          </div>
          <div>
            <h1 className="text-4xl font-black bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent">
              üî• Urgent Tasks
            </h1>
            <p className="text-muted-foreground font-bold">
              High priority tasks - showing all urgent items
            </p>
          </div>
        </div>
      </div>

      {/* Stats Grid - Showing All Tasks & Completed */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 animate-in fade-in slide-in-from-top-4 duration-500 delay-100">
        <div className="bg-gradient-to-br from-red-500/10 to-orange-500/10 border-2 border-red-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Active Urgent
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.urgentActive}
              </p>
            </div>
            <div className="text-5xl">‚ö†Ô∏è</div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-2 border-blue-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Total Urgent
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.urgentTotal}
              </p>
            </div>
            <div className="text-5xl">üìã</div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-2 border-green-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Completed
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.urgentCompleted}
              </p>
            </div>
            <div className="text-5xl">‚úÖ</div>
          </div>
        </div>
      </div>

      {urgentTasks.length > 0 ? (
        <div className="space-y-3">
          {urgentTasks.map((task, idx) => (
            <div
              key={task.id}
              className="animate-in fade-in slide-in-from-left-4"
              style={{ animationDelay: `${idx * 50}ms` }}
            >
              <UrgentTaskCard
                task={task}
                isEditing={editingId === task.id}
                onToggleComplete={handleToggleComplete}
                onToggleUrgent={handleToggleUrgent}
                onStartEdit={startEdit}
                onDelete={setDeleteConfirm}
                onSaveEdit={saveEdit}
                onCancelEdit={cancelEdit}
                editData={editData}
                onEditChange={handleEditChange}
              />
            </div>
          ))}
        </div>
      ) : (
        <div className="text-center py-20 animate-in fade-in zoom-in duration-500">
          <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-green-500/10 to-emerald-500/10 mb-4">
            <span className="text-6xl">‚ú®</span>
          </div>
          <h3 className="text-2xl font-black text-foreground mb-2">
            No urgent tasks!
          </h3>
          <p className="text-muted-foreground font-bold">
            You're all caught up. Great job! üéâ
          </p>
        </div>
      )}

      {isLoading && urgentTasks.length === 0 && (
        <div className="text-center py-20">
          <div className="inline-block w-10 h-10 border-4 border-red-500/30 border-t-red-500 rounded-full animate-spin" />
        </div>
      )}

      <ConfirmDialog
        isOpen={deleteConfirm !== null}
        onClose={() => setDeleteConfirm(null)}
        onConfirm={handleDelete}
        title="Delete Urgent Task"
        description="Are you sure you want to delete this urgent task? This action cannot be undone."
        confirmText="Yes, Delete"
        cancelText="Cancel"
        variant="danger"
      />
    </div>
  );
}





// src/components/theme-provider.tsx
import { createContext, useContext, useEffect, useState } from "react"

type Theme = "dark" | "light" | "system"

type ThemeProviderProps = {
  children: React.ReactNode
  defaultTheme?: Theme
  storageKey?: string
}

type ThemeProviderState = {
  theme: Theme
  setTheme: (theme: Theme) => void
}

const initialState: ThemeProviderState = {
  theme: "system",
  setTheme: () => null,
}

const ThemeProviderContext = createContext<ThemeProviderState>(initialState)

export function ThemeProvider({
  children,
  defaultTheme = "system",
  storageKey = "vite-ui-theme",
  ...props
}: ThemeProviderProps) {
  const [theme, setTheme] = useState<Theme>(
    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme
  )

  useEffect(() => {
    const root = window.document.documentElement

    root.classList.remove("light", "dark")

    if (theme === "system") {
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)")
        .matches
        ? "dark"
        : "light"

      root.classList.add(systemTheme)
      return
    }

    root.classList.add(theme)
  }, [theme])

  const value = {
    theme,
    setTheme: (theme: Theme) => {
      localStorage.setItem(storageKey, theme)
      setTheme(theme)
    },
  }

  return (
    <ThemeProviderContext.Provider {...props} value={value}>
      {children}
    </ThemeProviderContext.Provider>
  )
}

export const useTheme = () => {
  const context = useContext(ThemeProviderContext)

  if (context === undefined)
    throw new Error("useTheme must be used within a ThemeProvider")

  return context
}




// src/components/TaskCard.tsx - FIXED: Fully editable inputs
import { memo } from "react";
import {
  CheckCircle2,
  Circle,
  Trash2,
  Edit2,
  Calendar,
  Save,
  X,
  AlertCircle,
} from "lucide-react";
import { cn } from "@/lib/utils";
import type { Task } from "@/store";
import { CustomDatePicker } from "./CustomDatePicker";

interface TaskCardProps {
  task: Task;
  isEditing: boolean;
  editData: {
    title: string;
    description: string;
    deadline: string;
    isUrgent: boolean;
  };
  onEditChange: (field: string, value: any) => void;
  onToggleComplete: (id: number, status: boolean) => void;
  onToggleUrgent: (id: number, status: boolean) => void;
  onStartEdit: (task: Task) => void;
  onDeleteClick: (id: number) => void;
  onSaveEdit: (id: number) => void;
  onCancelEdit: () => void;
  variant?: "default" | "urgent" | "completed";
}

export const TaskCard = memo(
  ({
    task,
    isEditing,
    editData,
    onEditChange,
    onToggleComplete,
    onToggleUrgent,
    onStartEdit,
    onDeleteClick,
    onSaveEdit,
    onCancelEdit,
    variant = "default",
  }: TaskCardProps) => {
    const borderColor =
      variant === "urgent"
        ? "border-red-500/50 bg-red-500/5"
        : variant === "completed"
        ? "border-green-500/30 bg-green-500/5"
        : task.isUrgent && !task.completed
        ? "border-red-500/50 bg-red-500/5"
        : task.completed
        ? "border-green-500/30 bg-green-500/5"
        : "";

    return (
      <div
        className={cn(
          "group bg-card border-2 rounded-2xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5",
          borderColor,
          task.completed && "opacity-75"
        )}
      >
        <div className="flex items-start gap-4">
          {/* Complete Button */}
          <button
            type="button"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onToggleComplete(task.id, task.completed);
            }}
            disabled={isEditing}
            className={`mt-1 flex-shrink-0 transition-all hover:scale-110 ${
              task.completed
                ? "text-green-500"
                : "text-muted-foreground hover:text-green-500"
            } ${isEditing ? "opacity-50 cursor-not-allowed" : ""}`}
          >
            {task.completed ? (
              <CheckCircle2 className="w-6 h-6" />
            ) : (
              <Circle className="w-6 h-6" />
            )}
          </button>

          {/* Task Content */}
          <div className="flex-1 min-w-0">
            {isEditing ? (
              <div className="space-y-3">
                {/* Title Input - FIXED */}
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("title", e.target.value);
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                  }}
                  onFocus={(e) => e.target.select()}
                  placeholder="Task title..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-primary focus:ring-2 focus:ring-primary/20 outline-none font-bold"
                  autoFocus
                />

                {/* Description Textarea - FIXED */}
                <textarea
                  value={editData.description}
                  onChange={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("description", e.target.value);
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                  }}
                  placeholder="Description (optional)..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-input focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none"
                  rows={2}
                />

                {/* Date Picker - FIXED */}
                <div onClick={(e) => e.stopPropagation()}>
                  <CustomDatePicker
                    value={editData.deadline}
                    onChange={(val) => onEditChange("deadline", val)}
                  />
                </div>

                {/* Urgent Toggle - FIXED */}
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("isUrgent", !editData.isUrgent);
                  }}
                  className={`w-full px-4 py-2 rounded-lg font-bold transition-all ${
                    editData.isUrgent
                      ? "bg-red-500 text-white"
                      : "bg-secondary text-secondary-foreground"
                  }`}
                >
                  {editData.isUrgent ? "üî• Urgent" : "‚≠ê Normal"}
                </button>

                {/* Action Buttons */}
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      onSaveEdit(task.id);
                    }}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-purple-500 text-white font-bold hover:opacity-90 transition-all"
                  >
                    <Save className="w-4 h-4" />
                    Save
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      onCancelEdit();
                    }}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-secondary text-secondary-foreground font-bold hover:bg-secondary/80 transition-all"
                  >
                    <X className="w-4 h-4" />
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="flex items-start gap-2">
                  {/* Non-clickable urgent emoji */}
                  {task.isUrgent && !task.completed && (
                    <span
                      className="text-lg animate-pulse pointer-events-none select-none"
                      aria-label="Urgent task"
                      role="img"
                    >
                      üî•
                    </span>
                  )}
                  {task.completed && (
                    <span
                      className="text-lg pointer-events-none select-none"
                      aria-label="Completed task"
                      role="img"
                    >
                      ‚úÖ
                    </span>
                  )}
                  <p
                    className={cn(
                      "text-foreground font-bold text-lg",
                      task.completed && "line-through text-muted-foreground"
                    )}
                  >
                    {task.title}
                  </p>
                </div>
                {task.description && (
                  <p
                    className={cn(
                      "text-sm mt-1",
                      task.completed
                        ? "text-muted-foreground/70 line-through"
                        : "text-muted-foreground"
                    )}
                  >
                    {task.description}
                  </p>
                )}
                {task.deadline && (
                  <p className="text-xs text-muted-foreground mt-2 flex items-center gap-1 font-semibold">
                    <Calendar className="w-3 h-3" />
                    {new Date(task.deadline).toLocaleDateString("en-US", {
                      month: "short",
                      day: "numeric",
                      year: "numeric",
                    })}
                  </p>
                )}
              </>
            )}
          </div>

          {/* Action Buttons */}
          {!isEditing && (
            <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onToggleComplete(task.id, task.completed);
                }}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.completed
                    ? "text-green-500 hover:bg-green-500/10"
                    : "text-muted-foreground hover:text-green-500 hover:bg-green-500/10"
                }`}
                title={task.completed ? "Mark incomplete" : "Mark complete"}
              >
                <CheckCircle2 className="w-4 h-4" />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onToggleUrgent(task.id, task.isUrgent);
                }}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.isUrgent
                    ? "text-red-500 hover:bg-red-500/10"
                    : "text-muted-foreground hover:text-red-500 hover:bg-red-500/10"
                }`}
                title={task.isUrgent ? "Remove urgent" : "Mark urgent"}
              >
                <AlertCircle
                  className={cn("w-4 h-4", task.isUrgent && "fill-red-500")}
                />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onStartEdit(task);
                }}
                className="p-2 rounded-lg text-muted-foreground hover:text-primary hover:bg-primary/10 transition-all hover:scale-110"
              >
                <Edit2 className="w-4 h-4" />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onDeleteClick(task.id);
                }}
                className="p-2 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all hover:scale-110"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          )}
        </div>
      </div>
    );
  },
  (prev, next) => {
    return (
      prev.task.id === next.task.id &&
      prev.task.title === next.task.title &&
      prev.task.completed === next.task.completed &&
      prev.task.isUrgent === next.task.isUrgent &&
      prev.task.description === next.task.description &&
      prev.task.deadline === next.task.deadline &&
      prev.isEditing === next.isEditing &&
      prev.editData.title === next.editData.title &&
      prev.editData.description === next.editData.description &&
      prev.editData.deadline === next.editData.deadline &&
      prev.editData.isUrgent === next.editData.isUrgent
    );
  }
);

TaskCard.displayName = "TaskCard";

{
  "name": "taskaya",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@clerk/clerk-react": "^5.59.2",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-slot": "^1.2.4",
    "@tailwindcss/vite": "^4.1.18",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.562.0",
    "react": "^19.2.3",
    "react-dom": "^19.2.3",
    "react-hook-form": "^7.69.0",
    "react-router": "^7.11.0",
    "react-router-dom": "^7.11.0",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "^4.1.18",
    "zod": "^4.2.1",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.4",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "tw-animate-css": "^1.4.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  },
  "description": "This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.",
  "main": "eslint.config.js",
  "keywords": [],
  "author": "",
  "license": "ISC"
}




// src/components/SSOCallback.tsx
import { useEffect } from "react";
import { AuthenticateWithRedirectCallback } from "@clerk/clerk-react";
import { Loader2 } from "lucide-react";

export function SSOCallback() {
  useEffect(() => {
    console.log("üîÑ Processing SSO callback...");
  }, []);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-primary/5 to-purple-500/10">
      <div className="text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-primary to-purple-500 mb-6 animate-pulse shadow-2xl shadow-primary/30">
          <span className="text-4xl">üîê</span>
        </div>
        <div className="flex items-center gap-3 justify-center mb-4">
          <Loader2 className="w-6 h-6 animate-spin text-primary" />
          <p className="text-lg font-bold text-muted-foreground">
            Completing authentication...
          </p>
        </div>
        <p className="text-sm text-muted-foreground">
          Please wait while we redirect you
        </p>
      </div>
      <AuthenticateWithRedirectCallback />
    </div>
  );
}




// src/components/Side.tsx - FIXED: All Tasks shows total count
import { useMemo, useCallback, memo } from "react";
import { useNavigate } from "react-router-dom";
import { useAuthStore, useTaskStore } from "@/store";
import {
  CheckCircle2,
  Clock,
  LogOut,
  User,
  Menu,
  X,
  AlertCircle,
  ListTodo,
} from "lucide-react";
import { ModeToggle } from "./mode-toggle";
import { useState } from "react";
import { ConfirmDialog } from "./ConfirmDialog";

interface SideProps {
  activeView: "all" | "completed" | "urgent";
  onViewChange: (view: "all" | "completed" | "urgent") => void;
}

const AnimatedLogo = memo(() => {
  const text = "Taskaya";
  return (
    <div className="flex items-center gap-3">
      <span className="text-3xl animate-bounce">üìù</span>
      <h1 className="text-2xl font-black overflow-hidden">
        {text.split("").map((char, i) => (
          <span
            key={i}
            className="inline-block bg-gradient-to-r from-primary via-purple-500 to-primary bg-clip-text text-transparent animate-wave"
            style={{
              animationDelay: `${i * 0.1}s`,
              fontFamily: "'Righteous', 'Luckiest Guy', cursive",
            }}
          >
            {char}
          </span>
        ))}
      </h1>
    </div>
  );
});

AnimatedLogo.displayName = "AnimatedLogo";

const NavButton = memo(
  ({
    active,
    icon: Icon,
    label,
    count,
    subtitle,
    onClick,
    variant = "default",
  }: {
    active: boolean;
    icon: any;
    label: string;
    count?: number;
    subtitle?: string;
    onClick: () => void;
    variant?: "default" | "urgent";
  }) => {
    const bgClass = useMemo(() => {
      if (!active)
        return "text-muted-foreground hover:bg-accent hover:text-accent-foreground";
      if (variant === "urgent")
        return "bg-gradient-to-r from-red-500 to-orange-500 text-white shadow-lg shadow-red-500/25";
      return "bg-gradient-to-r from-primary to-purple-500 text-white shadow-lg shadow-primary/25";
    }, [active, variant]);

    const countClass = useMemo(() => {
      if (!active && variant === "urgent") return "bg-red-500/10 text-red-500";
      if (!active) return "bg-primary/10 text-primary";
      return "bg-white/20 text-white";
    }, [active, variant]);

    return (
      <button
        onClick={onClick}
        className={`w-full flex flex-col gap-2 px-4 py-3 rounded-xl transition-all duration-200 ${bgClass}`}
      >
        <div className="flex items-center gap-3 w-full">
          <Icon className="w-5 h-5 flex-shrink-0" />
          <span className="font-bold flex-1 text-left">{label}</span>
          {count !== undefined && count > 0 && (
            <span
              className={`px-3 py-1 rounded-full text-sm font-black ${countClass} ${
                variant === "urgent" && !active ? "animate-pulse" : ""
              }`}
            >
              {count}
            </span>
          )}
        </div>
        {subtitle && (
          <div className="text-xs opacity-80 pl-8 text-left">{subtitle}</div>
        )}
      </button>
    );
  }
);

NavButton.displayName = "NavButton";

export function Side({ activeView, onViewChange }: SideProps) {
  const navigate = useNavigate();
  const { user, logout } = useAuthStore();
  const { allTasks } = useTaskStore();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);

  const taskStats = useMemo(() => {
    const urgentActive = allTasks.filter(
      (t) => t.isUrgent && !t.completed
    ).length;
    const urgentCompleted = allTasks.filter(
      (t) => t.isUrgent && t.completed
    ).length;
    const urgentTotal = urgentActive + urgentCompleted;

    const normalPending = allTasks.filter(
      (t) => !t.isUrgent && !t.completed
    ).length;
    const completedTotal = allTasks.filter((t) => t.completed).length;
    const pendingTotal = urgentActive + normalPending;
    const totalTasks = allTasks.length; // This includes ALL tasks: completed, urgent, pending

    return {
      urgentActive,
      urgentCompleted,
      urgentTotal,
      normalPending,
      completedTotal,
      pendingTotal,
      totalTasks, // Total count = all tasks
    };
  }, [allTasks]);

  const handleLogout = useCallback(async () => {
    await logout();
    setShowLogoutConfirm(false);
    navigate("/auth", { replace: true });
  }, [logout, navigate]);

  const toggleMobileMenu = useCallback(() => {
    setIsMobileMenuOpen((prev) => !prev);
  }, []);

  const handleViewChange = useCallback(
    (view: "all" | "completed" | "urgent") => {
      onViewChange(view);
      setIsMobileMenuOpen(false);
    },
    [onViewChange]
  );

  const SidebarContent = useMemo(
    () => (
      <>
        <div className="p-6 border-b animate-in fade-in slide-in-from-left-4 duration-500">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-purple-500 flex items-center justify-center shadow-lg">
              <User className="w-6 h-6 text-white" />
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-bold text-foreground truncate">
                {user?.email}
              </p>
              <p className="text-xs text-muted-foreground">Task Master üöÄ</p>
            </div>
          </div>
        </div>

        <div className="p-4">
          <div className="bg-gradient-to-br from-primary/10 to-purple-500/10 border-2 border-primary/30 rounded-2xl p-4 animate-in fade-in duration-500">
            <div className="flex items-center gap-2 mb-3">
              <ListTodo className="w-5 h-5 text-primary" />
              <h3 className="font-black text-foreground">Task Overview</h3>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between items-center">
                <span className="text-muted-foreground font-semibold">
                  üî• Urgent (Total)
                </span>
                <span className="font-black text-red-500 text-lg">
                  {taskStats.urgentTotal}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-muted-foreground font-semibold">
                  üìã Pending Tasks
                </span>
                <span className="font-black text-primary text-lg">
                  {taskStats.pendingTotal}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-muted-foreground font-semibold">
                  ‚úÖ Completed
                </span>
                <span className="font-black text-green-500 text-lg">
                  {taskStats.completedTotal}
                </span>
              </div>
              <div className="pt-2 mt-2 border-t border-border flex justify-between items-center">
                <span className="text-foreground font-bold">Total Tasks</span>
                <span className="font-black text-foreground text-xl">
                  {taskStats.totalTasks}
                </span>
              </div>
            </div>
          </div>
        </div>

        <nav className="flex-1 p-4 space-y-2 overflow-auto">
          <div className="animate-in fade-in slide-in-from-left-4 duration-500 delay-100">
            <NavButton
              active={activeView === "all"}
              icon={Clock}
              label="All Tasks"
              count={taskStats.totalTasks}
              subtitle={`${taskStats.urgentTotal} urgent ‚Ä¢ ${taskStats.completedTotal} completed`}
              onClick={() => handleViewChange("all")}
            />
          </div>

          <div className="animate-in fade-in slide-in-from-left-4 duration-500 delay-150">
            <NavButton
              active={activeView === "urgent"}
              icon={AlertCircle}
              label="Urgent"
              count={taskStats.urgentTotal}
              subtitle={`${taskStats.totalTasks} all tasks ‚Ä¢ ${taskStats.completedTotal} completed`}
              onClick={() => handleViewChange("urgent")}
              variant="urgent"
            />
          </div>

          <div className="animate-in fade-in slide-in-from-left-4 duration-500 delay-200">
            <NavButton
              active={activeView === "completed"}
              icon={CheckCircle2}
              label="Completed"
              count={taskStats.completedTotal}
              subtitle={`${taskStats.totalTasks} all tasks ‚Ä¢ ${taskStats.urgentTotal} urgent`}
              onClick={() => handleViewChange("completed")}
            />
          </div>
        </nav>

        <div className="p-4 border-t space-y-3">
          <div className="flex items-center justify-between animate-in fade-in slide-in-from-left-4 duration-500 delay-300">
            <span className="text-sm font-bold text-muted-foreground">
              Theme
            </span>
            <ModeToggle />
          </div>
          <button
            onClick={() => setShowLogoutConfirm(true)}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition-all duration-200 animate-in fade-in slide-in-from-left-4 duration-500 delay-400"
          >
            <LogOut className="w-5 h-5" />
            <span className="font-bold">Logout</span>
          </button>
        </div>
      </>
    ),
    [user, activeView, taskStats, handleViewChange]
  );

  return (
    <>
      <div className="lg:hidden fixed top-0 left-0 right-0 z-50 bg-card border-b p-4 flex items-center justify-between">
        <AnimatedLogo />
        <button
          onClick={toggleMobileMenu}
          className="p-2 rounded-lg hover:bg-accent transition-colors"
        >
          {isMobileMenuOpen ? (
            <X className="w-6 h-6" />
          ) : (
            <Menu className="w-6 h-6" />
          )}
        </button>
      </div>

      {isMobileMenuOpen && (
        <div
          className="lg:hidden fixed inset-0 bg-background/80 backdrop-blur-sm z-40"
          onClick={() => setIsMobileMenuOpen(false)}
        />
      )}

      <aside
        className={`
          fixed lg:static inset-y-0 left-0 z-40
          w-72 bg-card border-r flex flex-col
          transform transition-transform duration-300 ease-in-out
          ${
            isMobileMenuOpen
              ? "translate-x-0"
              : "-translate-x-full lg:translate-x-0"
          }
        `}
      >
        <div className="hidden lg:block p-6 border-b animate-in fade-in slide-in-from-left-4 duration-500">
          <AnimatedLogo />
          <p className="text-xs text-muted-foreground mt-2 font-semibold">
            Your productivity companion ‚ú®
          </p>
        </div>

        {SidebarContent}
      </aside>

      <ConfirmDialog
        isOpen={showLogoutConfirm}
        onClose={() => setShowLogoutConfirm(false)}
        onConfirm={handleLogout}
        title="Logout Confirmation"
        description="Are you sure you want to logout? You'll need to sign in again to access your tasks."
        confirmText="Yes, Logout"
        cancelText="Cancel"
        variant="warning"
      />

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Righteous&display=swap');
        
        @keyframes wave {
          0%, 100% { 
            transform: translateY(0px);
            opacity: 1;
          }
          50% { 
            transform: translateY(-10px);
            opacity: 0.7;
          }
        }
        
        .animate-wave {
          animation: wave 3s ease-in-out infinite;
        }
      `}</style>
    </>
  );
}




// src/components/Search.tsx
import { useState, useEffect, useCallback, memo } from "react";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore, useTaskStore } from "@/store";
import { Search as SearchIcon, X, Sparkles } from "lucide-react";

interface SearchProps {
  authMethod: "clerk" | "jwt" | null;
}

export const Search = memo(({ authMethod }: SearchProps) => {
  const { getToken } = useAuth();
  const { token: jwtToken } = useAuthStore();
  const [query, setQuery] = useState("");
  const { tasks, allTasks, filterTasks, fetchTasks } = useTaskStore();

  // Load all tasks when component mounts
  useEffect(() => {
    const loadAllTasks = async () => {
      let token: string | null = null;

      if (authMethod === "clerk") {
        token = await getToken();
      } else if (authMethod === "jwt") {
        token = jwtToken;
      }

      if (token) {
        await fetchTasks(token, true);
      }
    };

    loadAllTasks();
  }, [fetchTasks, getToken, authMethod, jwtToken]);

  // Filter tasks when query changes
  useEffect(() => {
    filterTasks(query);
  }, [query, filterTasks]);

  const handleClear = useCallback(() => {
    setQuery("");
    filterTasks(""); // This will show all tasks
  }, [filterTasks]);

  const handleQueryChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      setQuery(e.target.value);
    },
    []
  );

  return (
    <div className="p-6 border-b bg-gradient-to-br from-card/50 to-primary/5 backdrop-blur-sm">
      <div className="relative animate-in fade-in slide-in-from-top-2 duration-500 group">
        <div className="absolute inset-0 bg-gradient-to-r from-primary/20 to-purple-500/20 rounded-2xl blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
        <div className="relative">
          <SearchIcon className="absolute left-5 top-1/2 -translate-y-1/2 w-6 h-6 text-muted-foreground group-hover:text-primary transition-colors z-10" />
          <Sparkles className="absolute left-14 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/50 animate-pulse z-10" />
          <input
            type="text"
            value={query}
            onChange={handleQueryChange}
            placeholder="üîç Search tasks... (instant results)"
            className="w-full pl-24 pr-14 py-4 rounded-2xl bg-background border-2 border-input focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all duration-200 placeholder:text-muted-foreground font-bold text-lg shadow-lg"
          />
          {query && (
            <button
              type="button"
              onClick={handleClear}
              className="absolute right-5 top-1/2 -translate-y-1/2 p-2 rounded-xl text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all hover:scale-110 z-10"
            >
              <X className="w-5 h-5" />
            </button>
          )}
        </div>

        {/* Search Results Counter */}
        {query && (
          <div className="mt-3 flex items-center gap-2 animate-in fade-in slide-in-from-top-2 duration-300">
            <div className="px-4 py-2 rounded-xl bg-primary/10 border border-primary/30">
              <span className="text-sm font-black text-primary">
                {tasks.length === 0 ? (
                  <>üòî No results</>
                ) : (
                  <>
                    ‚ú® Found {tasks.length}{" "}
                    {tasks.length === 1 ? "task" : "tasks"}
                  </>
                )}
              </span>
            </div>
            <div className="text-xs font-bold text-muted-foreground">
              out of {allTasks.length} total
            </div>
          </div>
        )}
      </div>
    </div>
  );
});

Search.displayName = "Search";





// src/components/Register.tsx - OPTIMIZED: Instant redirect after register
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useAuthStore } from "@/store";
import { Eye, EyeOff, UserPlus, Loader2, ArrowLeft } from "lucide-react";

interface RegisterProps {
  onSwitchToLogin: () => void;
  onBack: () => void;
}

export function Register({ onSwitchToLogin, onBack }: RegisterProps) {
  const navigate = useNavigate();
  const { register } = useAuthStore();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [errors, setErrors] = useState<{
    email?: string;
    password?: string;
    confirmPassword?: string;
  }>({});
  const [isLoading, setIsLoading] = useState(false);
  const [generalError, setGeneralError] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrors({});
    setGeneralError("");

    // Basic validation
    const fieldErrors: {
      email?: string;
      password?: string;
      confirmPassword?: string;
    } = {};

    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      fieldErrors.email = "Please enter a valid email address";
    }

    if (!password || password.length < 6) {
      fieldErrors.password = "Password must be at least 6 characters";
    }

    if (password !== confirmPassword) {
      fieldErrors.confirmPassword = "Passwords do not match";
    }

    if (Object.keys(fieldErrors).length > 0) {
      setErrors(fieldErrors);
      return;
    }

    setIsLoading(true);
    try {
      // OPTIMIZED: Register and immediately navigate
      await register(email, password);

      // INSTANT REDIRECT - No setTimeout, no delays
      navigate("/", { replace: true });
    } catch (err: any) {
      console.error("Registration error:", err);
      setGeneralError(err?.message || "Registration failed. Please try again.");
      setIsLoading(false); // Only set loading false on error
    }
    // Note: We don't set isLoading(false) on success to avoid re-render before navigation
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-primary/5 to-purple-500/10 p-4">
      <div className="w-full max-w-md">
        <button
          onClick={onBack}
          disabled={isLoading}
          className="mb-6 flex items-center gap-2 text-muted-foreground hover:text-foreground transition-all disabled:opacity-50"
        >
          <ArrowLeft className="w-5 h-5" />
          <span className="font-bold">Back to options</span>
        </button>

        <div className="text-center mb-8 animate-in fade-in slide-in-from-top-4 duration-700">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-primary to-purple-500 mb-6 animate-in zoom-in duration-500 delay-150 shadow-2xl shadow-primary/30">
            <span className="text-4xl">‚ú®</span>
          </div>
          <h1 className="text-5xl font-black mb-3">
            <span className="bg-gradient-to-r from-primary via-purple-500 to-primary bg-clip-text text-transparent bg-[length:200%_auto] animate-gradient">
              Join Taskaya! üöÄ
            </span>
          </h1>
          <p className="text-muted-foreground font-bold text-lg">
            Create your account to get started
          </p>
        </div>

        <div className="bg-card border-2 rounded-3xl p-8 shadow-2xl shadow-primary/10 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-100 backdrop-blur-xl">
          <form onSubmit={handleSubmit} className="space-y-6">
            {generalError && (
              <div className="p-4 rounded-2xl bg-destructive/10 border-2 border-destructive/30 text-destructive font-bold text-sm animate-in fade-in">
                ‚ö†Ô∏è {generalError}
              </div>
            )}

            <div className="space-y-2">
              <label className="text-sm font-black text-foreground">
                Email
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className={`w-full px-5 py-4 rounded-2xl bg-background border-2 ${
                  errors.email ? "border-destructive" : "border-input"
                } focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all font-bold shadow-lg`}
                placeholder="you@example.com"
                disabled={isLoading}
                autoComplete="email"
              />
              {errors.email && (
                <p className="text-destructive text-sm font-bold">
                  {errors.email}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="text-sm font-black text-foreground">
                Password
              </label>
              <div className="relative">
                <input
                  type={showPassword ? "text" : "password"}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className={`w-full px-5 py-4 pr-14 rounded-2xl bg-background border-2 ${
                    errors.password ? "border-destructive" : "border-input"
                  } focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all font-bold shadow-lg`}
                  placeholder="Create a password"
                  disabled={isLoading}
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-all hover:scale-110"
                  disabled={isLoading}
                  tabIndex={-1}
                >
                  {showPassword ? (
                    <EyeOff className="w-5 h-5" />
                  ) : (
                    <Eye className="w-5 h-5" />
                  )}
                </button>
              </div>
              {errors.password && (
                <p className="text-destructive text-sm font-bold">
                  {errors.password}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="text-sm font-black text-foreground">
                Confirm Password
              </label>
              <div className="relative">
                <input
                  type={showConfirmPassword ? "text" : "password"}
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className={`w-full px-5 py-4 pr-14 rounded-2xl bg-background border-2 ${
                    errors.confirmPassword
                      ? "border-destructive"
                      : "border-input"
                  } focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all font-bold shadow-lg`}
                  placeholder="Confirm your password"
                  disabled={isLoading}
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-all hover:scale-110"
                  disabled={isLoading}
                  tabIndex={-1}
                >
                  {showConfirmPassword ? (
                    <EyeOff className="w-5 h-5" />
                  ) : (
                    <Eye className="w-5 h-5" />
                  )}
                </button>
              </div>
              {errors.confirmPassword && (
                <p className="text-destructive text-sm font-bold">
                  {errors.confirmPassword}
                </p>
              )}
            </div>

            <button
              type="submit"
              disabled={isLoading}
              className="w-full py-4 rounded-2xl bg-gradient-to-r from-primary via-purple-500 to-primary text-white font-black text-lg hover:opacity-90 active:scale-95 transition-all shadow-2xl disabled:opacity-50 flex items-center justify-center gap-3 bg-[length:200%_auto] animate-gradient"
            >
              {isLoading ? (
                <>
                  <Loader2 className="w-6 h-6 animate-spin" />
                  Creating account...
                </>
              ) : (
                <>
                  <UserPlus className="w-6 h-6" />
                  Sign Up
                </>
              )}
            </button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-sm font-bold text-muted-foreground">
              Already have an account?{" "}
              <button
                onClick={onSwitchToLogin}
                className="text-primary font-black hover:underline transition-all"
                disabled={isLoading}
              >
                Sign in üëã
              </button>
            </p>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes gradient {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-gradient {
          animation: gradient 3s ease infinite;
        }
      `}</style>
    </div>
  );
}





// src/components/PageTransition.tsx
import { ReactNode, useEffect, useState } from 'react';
import { useLocation } from 'react-router-dom';

interface PageTransitionProps {
  children: ReactNode;
}

export function PageTransition({ children }: PageTransitionProps) {
  const location = useLocation();
  const [displayLocation, setDisplayLocation] = useState(location);
  const [transitionStage, setTransitionStage] = useState<'fadeIn' | 'fadeOut'>('fadeIn');

  useEffect(() => {
    if (location !== displayLocation) {
      setTransitionStage('fadeOut');
    }
  }, [location, displayLocation]);

  return (
    <div
      className={`page-transition ${transitionStage}`}
      onAnimationEnd={() => {
        if (transitionStage === 'fadeOut') {
          setTransitionStage('fadeIn');
          setDisplayLocation(location);
        }
      }}
    >
      {children}
    </div>
  );
}




// src/components/mode-toggle.tsx
import { Moon, Sun } from "lucide-react";
import { useTheme } from "@/components/theme-provider";
import { cn } from "@/lib/utils";

export function ModeToggle() {
  const { theme, setTheme } = useTheme();

  const isDark = theme === "dark";

  return (
    <button
      type="button"
      className="relative flex h-10 w-20 items-center rounded-full border bg-background p-1 shadow-sm transition-colors"
    >
      {/* Sliding indicator */}
      <span
        className={cn(
          "absolute left-1 top-1 h-8 w-8 rounded-full bg-primary shadow transition-all duration-300 ease-in-out",
          isDark ? "translate-x-10" : "translate-x-0"
        )}
      />

      {/* Light */}
      <span
        onClick={() => setTheme("light")}
        className="relative z-10 flex h-8 w-8 items-center justify-center"
      >
        <Sun
          className={cn(
            "h-5 w-5 transition-colors",
            isDark ? "text-muted-foreground" : "text-primary-foreground"
          )}
        />
      </span>

      {/* Dark */}
      <span
        onClick={() => setTheme("dark")}
        className="relative z-10 flex h-8 w-8 items-center justify-center"
      >
        <Moon
          className={cn(
            "h-5 w-5 transition-colors",
            isDark ? "text-primary-foreground" : "text-muted-foreground"
          )}
        />
      </span>
    </button>
  );
}






// src/components/Main.tsx - FIXED: Edit state management
import { useEffect, useState, useMemo, useCallback, memo } from "react";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore, useTaskStore } from "@/store";
import { useOutletContext, useNavigate } from "react-router-dom";
import type { Task } from "@/store";
import {
  CheckCircle2,
  Circle,
  Clock,
  Trash2,
  Edit2,
  Calendar,
  Save,
  X,
  AlertCircle,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { ConfirmDialog } from "./ConfirmDialog";
import { CustomDatePicker } from "./CustomDatePicker";

type OutletContext = {
  authMethod: "clerk" | "jwt" | null;
};

// Optimized TaskCard with memo and editable inputs
const TaskCard = memo(
  ({
    task,
    isEditing,
    editData,
    onEditChange,
    onToggleComplete,
    onToggleUrgent,
    onStartEdit,
    onDeleteClick,
    onSaveEdit,
    onCancelEdit,
  }: {
    task: Task;
    isEditing: boolean;
    editData: {
      title: string;
      description: string;
      deadline: string;
      isUrgent: boolean;
    };
    onEditChange: (field: string, value: any) => void;
    onToggleComplete: (id: number, status: boolean) => void;
    onToggleUrgent: (id: number, currentStatus: boolean) => void;
    onStartEdit: (task: Task) => void;
    onDeleteClick: (id: number) => void;
    onSaveEdit: (id: number) => void;
    onCancelEdit: () => void;
  }) => {
    return (
      <div
        className={cn(
          "group bg-card border-2 rounded-2xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5",
          task.isUrgent && !task.completed && "border-red-500/50 bg-red-500/5",
          task.completed && "border-green-500/30 bg-green-500/5 opacity-75"
        )}
      >
        <div className="flex items-start gap-4">
          <button
            type="button"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onToggleComplete(task.id, task.completed);
            }}
            disabled={isEditing}
            className={`mt-1 flex-shrink-0 transition-all hover:scale-110 ${
              task.completed
                ? "text-green-500"
                : "text-muted-foreground hover:text-green-500"
            } ${isEditing ? "opacity-50 cursor-not-allowed" : ""}`}
          >
            {task.completed ? (
              <CheckCircle2 className="w-6 h-6" />
            ) : (
              <Circle className="w-6 h-6" />
            )}
          </button>

          <div className="flex-1 min-w-0">
            {isEditing ? (
              <div className="space-y-3">
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("title", e.target.value);
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                  }}
                  onFocus={(e) => e.target.select()}
                  placeholder="Task title..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-primary focus:ring-2 focus:ring-primary/20 outline-none font-bold"
                  autoFocus
                />
                <textarea
                  value={editData.description}
                  onChange={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("description", e.target.value);
                  }}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                  }}
                  placeholder="Description (optional)..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-input focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none"
                  rows={2}
                />
                <div onClick={(e) => e.stopPropagation()}>
                  <CustomDatePicker
                    value={editData.deadline}
                    onChange={(val) => onEditChange("deadline", val)}
                  />
                </div>
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onEditChange("isUrgent", !editData.isUrgent);
                  }}
                  className={`w-full px-4 py-2 rounded-lg font-bold transition-all ${
                    editData.isUrgent
                      ? "bg-red-500 text-white"
                      : "bg-secondary text-secondary-foreground"
                  }`}
                >
                  {editData.isUrgent ? "üî• Urgent" : "‚≠ê Normal"}
                </button>
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      onSaveEdit(task.id);
                    }}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-purple-500 text-white font-bold hover:opacity-90 transition-all"
                  >
                    <Save className="w-4 h-4" />
                    Save
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      onCancelEdit();
                    }}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-secondary text-secondary-foreground font-bold hover:bg-secondary/80 transition-all"
                  >
                    <X className="w-4 h-4" />
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="flex items-start gap-2">
                  {task.isUrgent && !task.completed && (
                    <span
                      className="text-lg animate-pulse pointer-events-none select-none"
                      aria-label="Urgent task"
                      role="img"
                    >
                      üî•
                    </span>
                  )}
                  {task.completed && (
                    <span
                      className="text-lg pointer-events-none select-none"
                      aria-label="Completed task"
                      role="img"
                    >
                      ‚úÖ
                    </span>
                  )}
                  <p
                    className={cn(
                      "text-foreground font-bold text-lg",
                      task.completed && "line-through text-muted-foreground"
                    )}
                  >
                    {task.title}
                  </p>
                </div>
                {task.description && (
                  <p
                    className={cn(
                      "text-sm mt-1",
                      task.completed
                        ? "text-muted-foreground/70 line-through"
                        : "text-muted-foreground"
                    )}
                  >
                    {task.description}
                  </p>
                )}
                {task.deadline && (
                  <p className="text-xs text-muted-foreground mt-2 flex items-center gap-1 font-semibold">
                    <Calendar className="w-3 h-3" />
                    {new Date(task.deadline).toLocaleDateString("en-US", {
                      month: "short",
                      day: "numeric",
                      year: "numeric",
                    })}
                  </p>
                )}
              </>
            )}
          </div>

          {!isEditing && (
            <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onToggleComplete(task.id, task.completed);
                }}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.completed
                    ? "text-green-500 hover:bg-green-500/10"
                    : "text-muted-foreground hover:text-green-500 hover:bg-green-500/10"
                }`}
                title={task.completed ? "Mark incomplete" : "Mark complete"}
              >
                <CheckCircle2 className="w-4 h-4" />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onToggleUrgent(task.id, task.isUrgent);
                }}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.isUrgent
                    ? "text-red-500 hover:bg-red-500/10"
                    : "text-muted-foreground hover:text-red-500 hover:bg-red-500/10"
                }`}
                title={task.isUrgent ? "Remove urgent" : "Mark urgent"}
              >
                <AlertCircle
                  className={cn("w-4 h-4", task.isUrgent && "fill-red-500")}
                />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onStartEdit(task);
                }}
                className="p-2 rounded-lg text-muted-foreground hover:text-primary hover:bg-primary/10 transition-all hover:scale-110"
              >
                <Edit2 className="w-4 h-4" />
              </button>

              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onDeleteClick(task.id);
                }}
                className="p-2 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all hover:scale-110"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          )}
        </div>
      </div>
    );
  },
  (prev, next) => {
    return (
      prev.task.id === next.task.id &&
      prev.task.title === next.task.title &&
      prev.task.completed === next.task.completed &&
      prev.task.isUrgent === next.task.isUrgent &&
      prev.task.description === next.task.description &&
      prev.task.deadline === next.task.deadline &&
      prev.isEditing === next.isEditing &&
      prev.editData.title === next.editData.title &&
      prev.editData.description === next.editData.description &&
      prev.editData.deadline === next.editData.deadline &&
      prev.editData.isUrgent === next.editData.isUrgent
    );
  }
);

TaskCard.displayName = "TaskCard";

export function Main() {
  const navigate = useNavigate();
  const { getToken } = useAuth();
  const { token: jwtToken } = useAuthStore();
  const context = useOutletContext<OutletContext>();
  const authMethod = context?.authMethod || null;

  const { tasks, fetchTasks, updateTask, deleteTask, isLoading } =
    useTaskStore();
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editTitle, setEditTitle] = useState("");
  const [editDescription, setEditDescription] = useState("");
  const [editDeadline, setEditDeadline] = useState("");
  const [editIsUrgent, setEditIsUrgent] = useState(false);
  const [deleteConfirm, setDeleteConfirm] = useState<number | null>(null);

  useEffect(() => {
    const loadTasks = async () => {
      let token: string | null = null;
      if (authMethod === "clerk") {
        token = await getToken();
      } else if (authMethod === "jwt") {
        token = jwtToken;
      }
      if (token) {
        fetchTasks(token, true);
      }
    };
    loadTasks();
  }, [authMethod, fetchTasks, getToken, jwtToken]);

  const stats = useMemo(() => {
    const urgentActive = tasks.filter((t) => t.isUrgent && !t.completed).length;
    const normalActive = tasks.filter(
      (t) => !t.isUrgent && !t.completed
    ).length;
    const completed = tasks.filter((t) => t.completed).length;
    const urgentTotal = tasks.filter((t) => t.isUrgent).length;

    return {
      urgentCount: urgentActive,
      normalCount: normalActive,
      completedCount: completed,
      urgentTotal,
      totalTasks: tasks.length,
    };
  }, [tasks]);

  const sortedTasks = useMemo(() => {
    const urgentActive = tasks.filter((t) => t.isUrgent && !t.completed);
    const normalActive = tasks.filter((t) => !t.isUrgent && !t.completed);
    const completed = tasks.filter((t) => t.completed);
    return [...urgentActive, ...normalActive, ...completed];
  }, [tasks]);

  const getAuthToken = useCallback(async (): Promise<string | null> => {
    if (authMethod === "clerk") {
      return await getToken();
    } else if (authMethod === "jwt") {
      return jwtToken;
    }
    return null;
  }, [authMethod, getToken, jwtToken]);

  const handleToggleComplete = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        await updateTask(token, id, { completed: !currentStatus });
      }
    },
    [getAuthToken, updateTask]
  );

  const handleToggleUrgent = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        const newUrgentStatus = !currentStatus;
        await updateTask(token, id, { isUrgent: newUrgentStatus });

        if (newUrgentStatus) {
          console.log("üî• Navigating to Urgent tab");
          navigate("/urgent");
        }
      }
    },
    [getAuthToken, updateTask, navigate]
  );

  const handleStartEdit = useCallback((task: Task) => {
    console.log("‚úèÔ∏è Starting edit for task:", task.id);
    setEditingId(task.id);
    setEditTitle(task.title);
    setEditDescription(task.description || "");
    setEditDeadline(task.deadline || "");
    setEditIsUrgent(task.isUrgent);
  }, []);

  const handleSaveEdit = useCallback(
    async (id: number) => {
      if (!editTitle.trim()) {
        console.log("‚ùå Title is empty, cannot save");
        return;
      }

      console.log("üíæ Saving task:", {
        id,
        title: editTitle,
        description: editDescription,
        deadline: editDeadline,
        isUrgent: editIsUrgent,
      });

      const token = await getAuthToken();
      if (token) {
        await updateTask(token, id, {
          title: editTitle,
          description: editDescription || null,
          deadline: editDeadline || null,
          isUrgent: editIsUrgent,
        });
        setEditingId(null);
      }
    },
    [
      editTitle,
      editDescription,
      editDeadline,
      editIsUrgent,
      getAuthToken,
      updateTask,
    ]
  );

  const handleCancelEdit = useCallback(() => {
    console.log("‚ùå Canceling edit");
    setEditingId(null);
  }, []);

  const handleEditChange = useCallback((field: string, value: any) => {
    console.log("üìù Edit change:", field, "=", value);
    switch (field) {
      case "title":
        setEditTitle(value);
        break;
      case "description":
        setEditDescription(value);
        break;
      case "deadline":
        setEditDeadline(value);
        break;
      case "isUrgent":
        setEditIsUrgent(value);
        break;
    }
  }, []);

  const handleDelete = useCallback(async () => {
    if (!deleteConfirm) return;
    const token = await getAuthToken();
    if (token) {
      await deleteTask(token, deleteConfirm);
      setDeleteConfirm(null);
    }
  }, [deleteConfirm, getAuthToken, deleteTask]);

  const editData = useMemo(
    () => ({
      title: editTitle,
      description: editDescription,
      deadline: editDeadline,
      isUrgent: editIsUrgent,
    }),
    [editTitle, editDescription, editDeadline, editIsUrgent]
  );

  return (
    <div className="flex-1 p-6 space-y-6 overflow-auto">
      {/* Stats Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 animate-in fade-in slide-in-from-top-4 duration-500">
        <div className="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border border-blue-500/20 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <div className="flex items-center gap-4">
            <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500">
              <Calendar className="w-6 h-6 text-white" />
            </div>
            <div>
              <p className="text-3xl font-black text-foreground">
                {stats.totalTasks}
              </p>
              <p className="text-sm font-bold text-muted-foreground">Total</p>
            </div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-red-500/10 to-orange-500/10 border border-red-500/20 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <div className="flex items-center gap-4">
            <div className="p-3 rounded-xl bg-gradient-to-br from-red-500 to-orange-500">
              <AlertCircle className="w-6 h-6 text-white" />
            </div>
            <div>
              <p className="text-3xl font-black text-foreground">
                {stats.urgentTotal}
              </p>
              <p className="text-sm font-bold text-muted-foreground">Urgent</p>
            </div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-primary/10 to-purple-500/10 border border-primary/20 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <div className="flex items-center gap-4">
            <div className="p-3 rounded-xl bg-gradient-to-br from-primary to-purple-500">
              <Clock className="w-6 h-6 text-white" />
            </div>
            <div>
              <p className="text-3xl font-black text-foreground">
                {stats.normalCount}
              </p>
              <p className="text-sm font-bold text-muted-foreground">Pending</p>
            </div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/20 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <div className="flex items-center gap-4">
            <div className="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-500">
              <CheckCircle2 className="w-6 h-6 text-white" />
            </div>
            <div>
              <p className="text-3xl font-black text-foreground">
                {stats.completedCount}
              </p>
              <p className="text-sm font-bold text-muted-foreground">
                Completed
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Tasks List */}
      {sortedTasks.length > 0 ? (
        <div className="space-y-3">
          {stats.urgentCount > 0 && (
            <div className="flex items-center gap-2 px-2 py-1">
              <AlertCircle className="w-4 h-4 text-red-500" />
              <h3 className="text-sm font-black text-red-500 uppercase tracking-wide">
                Urgent Tasks ({stats.urgentCount})
              </h3>
              <div className="flex-1 h-px bg-red-500/30" />
            </div>
          )}

          {sortedTasks
            .filter((t) => t.isUrgent && !t.completed)
            .map((task, idx) => (
              <div
                key={task.id}
                className="animate-in fade-in slide-in-from-left-4"
                style={{ animationDelay: `${idx * 30}ms` }}
              >
                <TaskCard
                  task={task}
                  isEditing={editingId === task.id}
                  editData={editData}
                  onEditChange={handleEditChange}
                  onToggleComplete={handleToggleComplete}
                  onToggleUrgent={handleToggleUrgent}
                  onStartEdit={handleStartEdit}
                  onDeleteClick={setDeleteConfirm}
                  onSaveEdit={handleSaveEdit}
                  onCancelEdit={handleCancelEdit}
                />
              </div>
            ))}

          {stats.normalCount > 0 && (
            <div className="flex items-center gap-2 px-2 py-1 mt-4">
              <Clock className="w-4 h-4 text-primary" />
              <h3 className="text-sm font-black text-primary uppercase tracking-wide">
                Pending Tasks ({stats.normalCount})
              </h3>
              <div className="flex-1 h-px bg-primary/30" />
            </div>
          )}

          {sortedTasks
            .filter((t) => !t.isUrgent && !t.completed)
            .map((task, idx) => (
              <div
                key={task.id}
                className="animate-in fade-in slide-in-from-left-4"
                style={{
                  animationDelay: `${(idx + stats.urgentCount) * 30}ms`,
                }}
              >
                <TaskCard
                  task={task}
                  isEditing={editingId === task.id}
                  editData={editData}
                  onEditChange={handleEditChange}
                  onToggleComplete={handleToggleComplete}
                  onToggleUrgent={handleToggleUrgent}
                  onStartEdit={handleStartEdit}
                  onDeleteClick={setDeleteConfirm}
                  onSaveEdit={handleSaveEdit}
                  onCancelEdit={handleCancelEdit}
                />
              </div>
            ))}

          {stats.completedCount > 0 && (
            <div className="flex items-center gap-2 px-2 py-1 mt-4">
              <CheckCircle2 className="w-4 h-4 text-green-500" />
              <h3 className="text-sm font-black text-green-500 uppercase tracking-wide">
                Completed Tasks ({stats.completedCount})
              </h3>
              <div className="flex-1 h-px bg-green-500/30" />
            </div>
          )}

          {sortedTasks
            .filter((t) => t.completed)
            .map((task, idx) => (
              <div
                key={task.id}
                className="animate-in fade-in slide-in-from-left-4"
                style={{
                  animationDelay: `${
                    (idx + stats.urgentCount + stats.normalCount) * 30
                  }ms`,
                }}
              >
                <TaskCard
                  task={task}
                  isEditing={editingId === task.id}
                  editData={editData}
                  onEditChange={handleEditChange}
                  onToggleComplete={handleToggleComplete}
                  onToggleUrgent={handleToggleUrgent}
                  onStartEdit={handleStartEdit}
                  onDeleteClick={setDeleteConfirm}
                  onSaveEdit={handleSaveEdit}
                  onCancelEdit={handleCancelEdit}
                />
              </div>
            ))}
        </div>
      ) : (
        <div className="text-center py-20 animate-in fade-in zoom-in duration-500">
          <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-primary/10 to-purple-500/10 mb-4">
            <span className="text-5xl">üìù</span>
          </div>
          <h3 className="text-2xl font-black text-foreground mb-2">
            No tasks yet
          </h3>
          <p className="text-muted-foreground font-semibold">
            Create your first task to get started! üöÄ
          </p>
        </div>
      )}

      {isLoading && (
        <div className="text-center py-20">
          <div className="inline-block w-8 h-8 border-4 border-primary/30 border-t-primary rounded-full animate-spin" />
        </div>
      )}

      <ConfirmDialog
        isOpen={deleteConfirm !== null}
        onClose={() => setDeleteConfirm(null)}
        onConfirm={handleDelete}
        title="Delete Task"
        description="Are you sure you want to delete this task?"
        confirmText="Yes, Delete"
        cancelText="Cancel"
        variant="danger"
      />
    </div>
  );
}




// src/components/Login.tsx - OPTIMIZED: Instant redirect after login
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useAuthStore } from "@/store";
import { Eye, EyeOff, LogIn, Loader2, ArrowLeft } from "lucide-react";

interface LoginProps {
  onSwitchToRegister: () => void;
  onBack: () => void;
}

export function Login({ onSwitchToRegister, onBack }: LoginProps) {
  const navigate = useNavigate();
  const { login } = useAuthStore();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [errors, setErrors] = useState<{
    email?: string;
    password?: string;
  }>({});
  const [isLoading, setIsLoading] = useState(false);
  const [generalError, setGeneralError] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrors({});
    setGeneralError("");

    // Validate with basic checks
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      setErrors({ email: "Please enter a valid email address" });
      return;
    }

    if (!password || password.length < 6) {
      setErrors({ password: "Password must be at least 6 characters" });
      return;
    }

    setIsLoading(true);
    try {
      // OPTIMIZED: Login and immediately navigate
      await login(email, password);

      // INSTANT REDIRECT - No setTimeout, no delays
      navigate("/", { replace: true });
    } catch (err: any) {
      console.error("Login error:", err);
      setGeneralError(
        err?.message ||
          "Invalid credentials. Please check your email and password."
      );
      setIsLoading(false); // Only set loading false on error
    }
    // Note: We don't set isLoading(false) on success to avoid re-render before navigation
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-primary/5 to-purple-500/10 p-4">
      <div className="w-full max-w-md">
        <button
          onClick={onBack}
          disabled={isLoading}
          className="mb-6 flex items-center gap-2 text-muted-foreground hover:text-foreground transition-all disabled:opacity-50"
        >
          <ArrowLeft className="w-5 h-5" />
          <span className="font-bold">Back to options</span>
        </button>

        <div className="text-center mb-8 animate-in fade-in slide-in-from-top-4 duration-700">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-primary to-purple-500 mb-6 animate-in zoom-in duration-500 delay-150 shadow-2xl shadow-primary/30">
            <span className="text-4xl">üìù</span>
          </div>
          <h1 className="text-5xl font-black mb-3">
            <span className="bg-gradient-to-r from-primary via-purple-500 to-primary bg-clip-text text-transparent bg-[length:200%_auto] animate-gradient">
              Welcome Back! üëã
            </span>
          </h1>
          <p className="text-muted-foreground font-bold text-lg">
            Sign in to your account
          </p>
        </div>

        <div className="bg-card border-2 rounded-3xl p-8 shadow-2xl shadow-primary/10 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-100 backdrop-blur-xl">
          <form onSubmit={handleSubmit} className="space-y-6">
            {generalError && (
              <div className="p-4 rounded-2xl bg-destructive/10 border-2 border-destructive/30 text-destructive font-bold text-sm animate-in fade-in slide-in-from-top-2 duration-300">
                ‚ö†Ô∏è {generalError}
              </div>
            )}

            <div className="space-y-2">
              <label className="text-sm font-black text-foreground">
                Email
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className={`w-full px-5 py-4 rounded-2xl bg-background border-2 ${
                  errors.email ? "border-destructive" : "border-input"
                } focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all duration-200 placeholder:text-muted-foreground font-bold shadow-lg`}
                placeholder="you@example.com"
                disabled={isLoading}
                autoComplete="email"
              />
              {errors.email && (
                <p className="text-destructive text-sm font-bold">
                  {errors.email}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="text-sm font-black text-foreground">
                Password
              </label>
              <div className="relative">
                <input
                  type={showPassword ? "text" : "password"}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className={`w-full px-5 py-4 pr-14 rounded-2xl bg-background border-2 ${
                    errors.password ? "border-destructive" : "border-input"
                  } focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all duration-200 placeholder:text-muted-foreground font-bold shadow-lg`}
                  placeholder="Enter your password"
                  disabled={isLoading}
                  autoComplete="current-password"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-all hover:scale-110"
                  disabled={isLoading}
                  tabIndex={-1}
                >
                  {showPassword ? (
                    <EyeOff className="w-5 h-5" />
                  ) : (
                    <Eye className="w-5 h-5" />
                  )}
                </button>
              </div>
              {errors.password && (
                <p className="text-destructive text-sm font-bold">
                  {errors.password}
                </p>
              )}
            </div>

            <button
              type="submit"
              disabled={isLoading}
              className="w-full py-4 rounded-2xl bg-gradient-to-r from-primary via-purple-500 to-primary text-white font-black text-lg hover:opacity-90 active:scale-95 transition-all duration-200 shadow-2xl shadow-primary/30 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 bg-[length:200%_auto] animate-gradient"
            >
              {isLoading ? (
                <>
                  <Loader2 className="w-6 h-6 animate-spin" />
                  Signing in...
                </>
              ) : (
                <>
                  <LogIn className="w-6 h-6" />
                  Sign In
                </>
              )}
            </button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-sm font-bold text-muted-foreground">
              Don't have an account?{" "}
              <button
                onClick={onSwitchToRegister}
                className="text-primary font-black hover:underline transition-all"
                disabled={isLoading}
              >
                Sign up üöÄ
              </button>
            </p>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes gradient {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-gradient {
          animation: gradient 3s ease infinite;
        }
      `}</style>
    </div>
  );
}




// src/components/Important.tsx
import { useEffect } from 'react';
import { useTaskStore } from '@/store';
import { Star, Circle, CheckCircle2, Trash2, Edit2, Calendar } from 'lucide-react';
import { cn } from '@/lib/utils';

export function Important() {
  const { tasks, fetchTasks, completeTask, deleteTask, isLoading } = useTaskStore();

  useEffect(() => {
    fetchTasks();
  }, [fetchTasks]);

  // Filter tasks with deadlines (important tasks)
  const importantTasks = tasks.filter(t => t.deadline && !t.completed);

  const handleComplete = async (id: number) => {
    await completeTask(id);
  };

  const handleDelete = async (id: number) => {
    await deleteTask(id);
  };

  return (
    <div className="flex-1 p-6 space-y-6 overflow-auto">
      {/* Header */}
      <div className="animate-in fade-in slide-in-from-top-4 duration-500">
        <div className="flex items-center gap-3 mb-4">
          <div className="p-3 rounded-xl bg-amber-500/10">
            <Star className="w-6 h-6 text-amber-500" />
          </div>
          <div>
            <h1 className="text-3xl font-bold text-foreground">Important Tasks</h1>
            <p className="text-muted-foreground">Tasks with deadlines</p>
          </div>
        </div>
      </div>

      {/* Important Tasks List */}
      {importantTasks.length > 0 ? (
        <div className="space-y-3">
          {importantTasks.map((task, idx) => (
            <div
              key={task.id}
              className={cn(
                "group bg-card border border-amber-500/20 rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-0.5",
                "animate-in fade-in slide-in-from-left-4"
              )}
              style={{ animationDelay: `${idx * 50}ms` }}
            >
              <div className="flex items-start gap-4">
                <button
                  onClick={() => handleComplete(task.id)}
                  className="mt-1 flex-shrink-0 text-muted-foreground hover:text-primary transition-colors"
                >
                  <Circle className="w-5 h-5" />
                </button>

                <div className="flex-1 min-w-0">
                  <div className="flex items-start gap-2">
                    <Star className="w-4 h-4 text-amber-500 fill-amber-500 flex-shrink-0 mt-1" />
                    <div className="flex-1">
                      <p className="text-foreground font-medium">{task.description}</p>
                      {task.deadline && (
                        <p className="text-sm text-amber-600 dark:text-amber-400 mt-2 flex items-center gap-1 font-medium">
                          <Calendar className="w-4 h-4" />
                          Due: {new Date(task.deadline).toLocaleDateString()}
                        </p>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    onClick={() => handleDelete(task.id)}
                    className="p-2 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div className="text-center py-20 animate-in fade-in zoom-in duration-500">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-amber-500/10 mb-4">
            <Star className="w-10 h-10 text-amber-500" />
          </div>
          <h3 className="text-xl font-semibold text-foreground mb-2">No important tasks</h3>
          <p className="text-muted-foreground">Add deadlines to tasks to mark them as important</p>
        </div>
      )}

      {isLoading && importantTasks.length === 0 && (
        <div className="text-center py-20">
          <div className="inline-block w-8 h-8 border-4 border-primary/30 border-t-primary rounded-full animate-spin" />
        </div>
      )}
    </div>
  );
}



// src/components/ErrorBoundary.tsx
import { Component, ErrorInfo, ReactNode } from 'react';
import { AlertTriangle, RefreshCw, Home } from 'lucide-react';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
    };
  }

  static getDerivedStateFromError(error: Error): State {
    return {
      hasError: true,
      error,
    };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  handleReset = () => {
    this.setState({ hasError: false, error: null });
    window.location.reload();
  };

  handleGoHome = () => {
    this.setState({ hasError: false, error: null });
    window.location.href = '/';
  };

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-destructive/5 to-red-500/10 p-4">
          <div className="max-w-md w-full">
            <div className="text-center mb-8 animate-in fade-in slide-in-from-top-4 duration-700">
              <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-destructive to-red-500 mb-6 animate-pulse shadow-2xl shadow-destructive/30">
                <AlertTriangle className="w-10 h-10 text-white" />
              </div>
              <h1 className="text-4xl font-black mb-3 bg-gradient-to-r from-destructive to-red-500 bg-clip-text text-transparent">
                Oops! Something went wrong
              </h1>
              <p className="text-muted-foreground font-bold text-lg">
                We encountered an unexpected error
              </p>
            </div>

            <div className="bg-card border-2 border-destructive/30 rounded-3xl p-6 shadow-2xl mb-6 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-100">
              <p className="text-sm text-muted-foreground font-mono bg-secondary/50 p-4 rounded-lg overflow-auto max-h-32">
                {this.state.error?.message || 'Unknown error'}
              </p>
            </div>

            <div className="space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-200">
              <button
                onClick={this.handleReset}
                className="w-full py-4 rounded-2xl bg-gradient-to-r from-primary to-purple-500 text-white font-black text-lg hover:opacity-90 active:scale-95 transition-all shadow-xl flex items-center justify-center gap-3"
              >
                <RefreshCw className="w-6 h-6" />
                Reload Page
              </button>

              <button
                onClick={this.handleGoHome}
                className="w-full py-4 rounded-2xl border-2 border-input bg-background hover:bg-accent text-foreground font-black text-lg hover:border-primary transition-all flex items-center justify-center gap-3"
              >
                <Home className="w-6 h-6" />
                Go to Home
              </button>
            </div>

            <p className="text-center text-xs text-muted-foreground mt-6">
              If this problem persists, please contact support
            </p>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}






// src/components/CustomDatePicker.tsx
import { useState, useRef, useEffect } from "react";
import { Calendar, X, ChevronLeft, ChevronRight } from "lucide-react";

interface CustomDatePickerProps {
  value: string;
  onChange: (value: string) => void;
  disabled?: boolean;
}

export function CustomDatePicker({
  value,
  onChange,
  disabled,
}: CustomDatePickerProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [currentMonth, setCurrentMonth] = useState(
    value ? new Date(value) : new Date()
  );
  const pickerRef = useRef<HTMLDivElement>(null);
  const buttonRef = useRef<HTMLButtonElement>(null);
  const clearButtonRef = useRef<HTMLButtonElement>(null);

  const formatDate = (dateStr: string) => {
    if (!dateStr) return "Pick a date";
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    } catch {
      return "Pick a date";
    }
  };

  const clearDate = (e: React.MouseEvent) => {
    e.stopPropagation();
    onChange("");
    setIsOpen(false);
  };

  // Close calendar when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        pickerRef.current &&
        !pickerRef.current.contains(event.target as Node) &&
        buttonRef.current &&
        !buttonRef.current.contains(event.target as Node) &&
        clearButtonRef.current &&
        !clearButtonRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    };

    if (isOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isOpen]);

  const getDaysInMonth = (date: Date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    return { daysInMonth, startingDayOfWeek, year, month };
  };

  const handlePrevMonth = () => {
    setCurrentMonth(
      new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1)
    );
  };

  const handleNextMonth = () => {
    setCurrentMonth(
      new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1)
    );
  };

  const handleDateSelect = (day: number) => {
    const selectedDate = new Date(
      currentMonth.getFullYear(),
      currentMonth.getMonth(),
      day
    );
    onChange(selectedDate.toISOString().split("T")[0]);
    setIsOpen(false);
  };

  const isDateSelected = (day: number) => {
    if (!value) return false;
    try {
      const selectedDate = new Date(value);
      return (
        selectedDate.getDate() === day &&
        selectedDate.getMonth() === currentMonth.getMonth() &&
        selectedDate.getFullYear() === currentMonth.getFullYear()
      );
    } catch {
      return false;
    }
  };

  const isToday = (day: number) => {
    const today = new Date();
    return (
      today.getDate() === day &&
      today.getMonth() === currentMonth.getMonth() &&
      today.getFullYear() === currentMonth.getFullYear()
    );
  };

  const isPastDate = (day: number) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const checkDate = new Date(
      currentMonth.getFullYear(),
      currentMonth.getMonth(),
      day
    );
    checkDate.setHours(0, 0, 0, 0);
    return checkDate < today;
  };

  const { daysInMonth, startingDayOfWeek, year, month } =
    getDaysInMonth(currentMonth);

  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
  const emptyDays = Array.from({ length: startingDayOfWeek }, (_, i) => i);

  const monthNames = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];

  const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  return (
    <div className="relative w-full">
      {/* Button Container with Clear Button */}
      <div className="relative w-full">
        <button
          ref={buttonRef}
          type="button"
          onClick={() => !disabled && setIsOpen(!isOpen)}
          disabled={disabled}
          className={`w-full px-4 py-3 rounded-xl bg-background border-2 border-input hover:border-primary transition-all duration-200 flex items-center gap-3 group ${
            disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer"
          } ${value ? "border-primary/50 pr-12" : ""}`}
        >
          <Calendar className="w-5 h-5 text-muted-foreground group-hover:text-primary transition-colors flex-shrink-0" />
          <span
            className={`text-sm font-bold flex-1 text-left ${
              value ? "text-foreground" : "text-muted-foreground"
            }`}
          >
            {formatDate(value)}
          </span>
        </button>
        
        {/* Clear Button - OUTSIDE the main button */}
        {value && !disabled && (
          <button
            ref={clearButtonRef}
            type="button"
            onClick={clearDate}
            className="absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-destructive/10 hover:text-destructive transition-all z-10"
          >
            <X className="w-4 h-4" />
          </button>
        )}
      </div>

      {/* Calendar Popup */}
      {isOpen && !disabled && (
        <div 
          ref={pickerRef}
          className="absolute top-full left-0 mt-2 z-50 bg-card border-2 border-primary/30 rounded-2xl shadow-2xl p-4 w-80 animate-in fade-in zoom-in-95 slide-in-from-top-2 duration-200"
        >
          {/* Header */}
          <div className="flex items-center justify-between mb-4 pb-3 border-b border-border">
            <button
              type="button"
              onClick={handlePrevMonth}
              className="p-2 rounded-lg hover:bg-accent transition-all hover:scale-110"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h3 className="text-base font-black bg-gradient-to-r from-primary to-purple-500 bg-clip-text text-transparent">
              {monthNames[month]} {year}
            </h3>
            <button
              type="button"
              onClick={handleNextMonth}
              className="p-2 rounded-lg hover:bg-accent transition-all hover:scale-110"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </div>

          {/* Day Names */}
          <div className="grid grid-cols-7 gap-1 mb-2">
            {dayNames.map((day, i) => (
              <div
                key={i}
                className="text-center text-xs font-bold text-muted-foreground py-2"
              >
                {day}
              </div>
            ))}
          </div>

          {/* Calendar Days */}
          <div className="grid grid-cols-7 gap-1">
            {emptyDays.map((_, index) => (
              <div key={`empty-${index}`} className="aspect-square" />
            ))}
            {days.map((day) => {
              const selected = isDateSelected(day);
              const today = isToday(day);
              const past = isPastDate(day);

              return (
                <button
                  key={day}
                  type="button"
                  onClick={() => handleDateSelect(day)}
                  disabled={past}
                  className={`
                    aspect-square rounded-lg text-sm font-bold transition-all hover:scale-110
                    ${
                      selected
                        ? "bg-gradient-to-br from-primary to-purple-500 text-white shadow-lg scale-110"
                        : today
                        ? "bg-primary/10 text-primary border-2 border-primary/30"
                        : past
                        ? "text-muted-foreground/30 cursor-not-allowed"
                        : "hover:bg-accent text-foreground"
                    }
                  `}
                >
                  {day}
                </button>
              );
            })}
          </div>

          {/* Footer */}
          <div className="mt-4 pt-3 border-t border-border flex justify-between items-center">
            <button
              type="button"
              onClick={() => {
                const today = new Date();
                onChange(today.toISOString().split("T")[0]);
                setIsOpen(false);
              }}
              className="text-xs font-bold text-primary hover:underline"
            >
              Today
            </button>
            <button
              type="button"
              onClick={() => setIsOpen(false)}
              className="text-xs font-bold text-muted-foreground hover:text-foreground"
            >
              Close
            </button>
          </div>
        </div>
      )}
    </div>
  );
}




// src/components/ConfirmDialog.tsx
import { AlertTriangle, Loader2 } from "lucide-react";

interface ConfirmDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  description: string;
  confirmText?: string;
  cancelText?: string;
  isLoading?: boolean;
  variant?: "danger" | "warning";
}

export function ConfirmDialog({
  isOpen,
  onClose,
  onConfirm,
  title,
  description,
  confirmText = "Confirm",
  cancelText = "Cancel",
  isLoading = false,
  variant = "danger",
}: ConfirmDialogProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      {/* Overlay */}
      <div
        className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200"
        onClick={onClose}
      />

      {/* Dialog */}
      <div className="relative bg-card border rounded-2xl p-6 max-w-md w-full shadow-2xl animate-in zoom-in-95 slide-in-from-bottom-4 duration-300">
        {/* Icon */}
        <div
          className={`inline-flex items-center justify-center w-14 h-14 rounded-full mb-4 ${
            variant === "danger" ? "bg-destructive/10" : "bg-amber-500/10"
          }`}
        >
          <AlertTriangle
            className={`w-7 h-7 ${
              variant === "danger" ? "text-destructive" : "text-amber-500"
            }`}
          />
        </div>

        {/* Content */}
        <h3 className="text-xl font-bold text-foreground mb-2">{title}</h3>
        <p className="text-muted-foreground mb-6">{description}</p>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="flex-1 px-4 py-2.5 rounded-xl bg-secondary text-secondary-foreground font-medium hover:bg-secondary/80 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`flex-1 px-4 py-2.5 rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${
              variant === "danger"
                ? "bg-destructive text-white hover:bg-destructive/90"
                : "bg-amber-500 text-white hover:bg-amber-600"
            }`}
          >
            {isLoading ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin" />
                Processing...
              </>
            ) : (
              confirmText
            )}
          </button>
        </div>
      </div>
    </div>
  );
}





// src/components/Completed.tsx - ENHANCED with navigation on toggle
import { useEffect, useState, useMemo, useCallback, memo } from "react";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore, useTaskStore } from "@/store";
import { useOutletContext, useNavigate } from "react-router-dom";
import type { Task } from "@/store";
import {
  CheckCircle2,
  Circle,
  Trash2,
  Edit2,
  Calendar,
  Save,
  X,
  AlertCircle,
  Clock,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { ConfirmDialog } from "./ConfirmDialog";
import { CustomDatePicker } from "./CustomDatePicker";

const CompletedTaskCard = memo(
  ({
    task,
    isEditing,
    onToggleComplete,
    onToggleUrgent,
    onStartEdit,
    onDelete,
    onSaveEdit,
    onCancelEdit,
    editData,
    onEditChange,
  }: {
    task: Task;
    isEditing: boolean;
    onToggleComplete: (id: number, status: boolean) => void;
    onToggleUrgent: (id: number, status: boolean) => void;
    onStartEdit: (task: Task) => void;
    onDelete: (id: number) => void;
    onSaveEdit: (id: number) => void;
    onCancelEdit: () => void;
    editData: {
      title: string;
      description: string;
      deadline: string;
      isUrgent: boolean;
    };
    onEditChange: (field: string, value: any) => void;
  }) => {
    return (
      <div className="group bg-gradient-to-br from-green-500/5 to-emerald-500/5 border-2 border-green-500/30 rounded-2xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
        <div className="flex items-start gap-4">
          <button
            onClick={() => onToggleComplete(task.id, task.completed)}
            className="mt-1 flex-shrink-0 text-green-500 hover:text-muted-foreground transition-all hover:scale-125"
          >
            <CheckCircle2 className="w-6 h-6" />
          </button>

          <div className="flex-1 min-w-0">
            {isEditing ? (
              <div className="space-y-3">
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => onEditChange("title", e.target.value)}
                  placeholder="Task title..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-green-500 focus:ring-2 focus:ring-green-500/20 outline-none font-bold"
                  autoFocus
                />
                <textarea
                  value={editData.description}
                  onChange={(e) => onEditChange("description", e.target.value)}
                  placeholder="Description (optional)..."
                  className="w-full px-3 py-2 rounded-lg bg-background border-2 border-input focus:border-green-500 focus:ring-2 focus:ring-green-500/20 outline-none resize-none"
                  rows={2}
                />
                <CustomDatePicker
                  value={editData.deadline}
                  onChange={(val) => onEditChange("deadline", val)}
                />
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    onEditChange("isUrgent", !editData.isUrgent);
                  }}
                  className={`w-full px-4 py-2 rounded-lg font-bold transition-all ${
                    editData.isUrgent
                      ? "bg-red-500 text-white"
                      : "bg-secondary text-secondary-foreground"
                  }`}
                >
                  {editData.isUrgent ? "üî• Urgent" : "‚≠ê Normal"}
                </button>
                <div className="flex gap-2">
                  <button
                    onClick={() => onSaveEdit(task.id)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold hover:opacity-90 transition-all"
                  >
                    <Save className="w-4 h-4" />
                    Save
                  </button>
                  <button
                    onClick={onCancelEdit}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-secondary text-secondary-foreground font-bold hover:bg-secondary/80 transition-all"
                  >
                    <X className="w-4 h-4" />
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <>
                <div className="flex items-start gap-2">
                  <span
                    className="text-2xl pointer-events-none select-none"
                    aria-label="Completed task"
                    role="img"
                  >
                    ‚úÖ
                  </span>
                  {task.isUrgent && (
                    <span
                      className="text-lg pointer-events-none select-none"
                      aria-label="Urgent task"
                      role="img"
                    >
                      üî•
                    </span>
                  )}
                  <div className="flex-1">
                    <p className="text-muted-foreground font-black text-xl line-through">
                      {task.title}
                    </p>
                    {task.description && (
                      <p className="text-muted-foreground/70 font-semibold text-sm mt-1 line-through">
                        {task.description}
                      </p>
                    )}
                    {task.deadline && (
                      <div className="flex items-center gap-2 mt-3">
                        <div className="px-3 py-1 rounded-lg bg-green-500/20 border border-green-500/30 flex items-center gap-2">
                          <Calendar className="w-4 h-4 text-green-500" />
                          <span className="text-sm font-bold text-green-500">
                            Completed:{" "}
                            {new Date(task.deadline).toLocaleDateString(
                              "en-US",
                              {
                                month: "short",
                                day: "numeric",
                                year: "numeric",
                              }
                            )}
                          </span>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}
          </div>

          {!isEditing && (
            <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                onClick={() => onToggleComplete(task.id, task.completed)}
                className="p-2 rounded-lg text-green-500 hover:bg-green-500/10 transition-all hover:scale-110"
                title="Mark as incomplete"
              >
                <Circle className="w-4 h-4" />
              </button>

              <button
                onClick={() => onToggleUrgent(task.id, task.isUrgent)}
                className={`p-2 rounded-lg transition-all hover:scale-110 ${
                  task.isUrgent
                    ? "text-red-500 hover:bg-red-500/10"
                    : "text-muted-foreground hover:text-red-500 hover:bg-red-500/10"
                }`}
                title={task.isUrgent ? "Remove urgent" : "Mark urgent"}
              >
                <AlertCircle
                  className={cn("w-4 h-4", task.isUrgent && "fill-red-500")}
                />
              </button>

              <button
                onClick={() => onStartEdit(task)}
                className="p-2 rounded-lg text-muted-foreground hover:text-green-500 hover:bg-green-500/10 transition-all hover:scale-110"
              >
                <Edit2 className="w-4 h-4" />
              </button>
              <button
                onClick={() => onDelete(task.id)}
                className="p-2 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all hover:scale-110"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }
);

CompletedTaskCard.displayName = "CompletedTaskCard";

type OutletContext = {
  authMethod: "clerk" | "jwt" | null;
};

export function Completed({
  authMethod: propAuthMethod,
}: {
  authMethod?: "clerk" | "jwt" | null;
}) {
  const navigate = useNavigate();
  const { getToken } = useAuth();
  const { token: jwtToken } = useAuthStore();
  const outletContext = useOutletContext<OutletContext>();

  const authMethod = propAuthMethod || outletContext?.authMethod || null;

  const { tasks, getCompletedTasks, updateTask, deleteTask, isLoading } =
    useTaskStore();
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editTitle, setEditTitle] = useState("");
  const [editDescription, setEditDescription] = useState("");
  const [editDeadline, setEditDeadline] = useState("");
  const [editIsUrgent, setEditIsUrgent] = useState(false);
  const [deleteConfirm, setDeleteConfirm] = useState<number | null>(null);

  useEffect(() => {
    const loadCompletedTasks = async () => {
      let token: string | null = null;

      if (authMethod === "clerk") {
        token = await getToken();
      } else if (authMethod === "jwt") {
        token = jwtToken;
      }

      if (token) {
        getCompletedTasks(token);
      }
    };
    loadCompletedTasks();
  }, [getCompletedTasks, getToken, authMethod, jwtToken]);

  const completedTasks = useMemo(
    () => tasks.filter((t) => t.completed === true),
    [tasks]
  );

  const stats = useMemo(() => {
    const completedTotal = completedTasks.length;
    const completedUrgent = completedTasks.filter((t) => t.isUrgent).length;
    const completedNormal = completedTotal - completedUrgent;

    return {
      completedTotal,
      completedUrgent,
      completedNormal,
    };
  }, [completedTasks]);

  const getAuthToken = useCallback(async (): Promise<string | null> => {
    if (authMethod === "clerk") {
      return await getToken();
    } else if (authMethod === "jwt") {
      return jwtToken;
    }
    return null;
  }, [authMethod, getToken, jwtToken]);

  const handleToggleComplete = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        await updateTask(token, id, { completed: !currentStatus });
      }
    },
    [getAuthToken, updateTask]
  );

  // ‚úÖ NEW: Navigate to Urgent ONLY when marking completed task as urgent
  const handleToggleUrgent = useCallback(
    async (id: number, currentStatus: boolean) => {
      const token = await getAuthToken();
      if (token) {
        const newUrgentStatus = !currentStatus;
        await updateTask(token, id, { isUrgent: newUrgentStatus });
        
        // ‚úÖ Navigate to Urgent tab ONLY if marking as urgent
        if (newUrgentStatus) {
          console.log("üî• Navigating to Urgent tab from Completed");
          navigate("/urgent");
        }
        // ‚ùå Do NOT navigate when removing urgent status
      }
    },
    [getAuthToken, updateTask, navigate]
  );

  const handleDelete = useCallback(async () => {
    if (deleteConfirm) {
      const token = await getAuthToken();
      if (token) {
        await deleteTask(token, deleteConfirm);
        setDeleteConfirm(null);
      }
    }
  }, [deleteConfirm, getAuthToken, deleteTask]);

  const startEdit = useCallback((task: Task) => {
    setEditingId(task.id);
    setEditTitle(task.title);
    setEditDescription(task.description || "");
    setEditDeadline(task.deadline || "");
    setEditIsUrgent(task.isUrgent);
  }, []);

  const saveEdit = useCallback(
    async (id: number) => {
      if (editTitle.trim()) {
        const token = await getAuthToken();
        if (token) {
          await updateTask(token, id, {
            title: editTitle,
            description: editDescription || null,
            deadline: editDeadline || null,
            isUrgent: editIsUrgent,
            completed: true,
          });
          setEditingId(null);
        }
      }
    },
    [
      editTitle,
      editDescription,
      editDeadline,
      editIsUrgent,
      getAuthToken,
      updateTask,
    ]
  );

  const cancelEdit = useCallback(() => {
    setEditingId(null);
    setEditTitle("");
    setEditDescription("");
    setEditDeadline("");
    setEditIsUrgent(false);
  }, []);

  const handleEditChange = useCallback((field: string, value: any) => {
    switch (field) {
      case "title":
        setEditTitle(value);
        break;
      case "description":
        setEditDescription(value);
        break;
      case "deadline":
        setEditDeadline(value);
        break;
      case "isUrgent":
        setEditIsUrgent(value);
        break;
    }
  }, []);

  const editData = useMemo(
    () => ({
      title: editTitle,
      description: editDescription,
      deadline: editDeadline,
      isUrgent: editIsUrgent,
    }),
    [editTitle, editDescription, editDeadline, editIsUrgent]
  );

  return (
    <div className="flex-1 p-6 space-y-6 overflow-auto">
      <div className="animate-in fade-in slide-in-from-top-4 duration-500">
        <div className="flex items-center gap-3 mb-4">
          <div className="p-4 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-500 shadow-lg shadow-green-500/25">
            <CheckCircle2 className="w-8 h-8 text-white" />
          </div>
          <div>
            <h1 className="text-4xl font-black bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent">
              ‚úÖ Completed Tasks
            </h1>
            <p className="text-muted-foreground font-bold">
              Well done! Your finished tasks
            </p>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 animate-in fade-in slide-in-from-top-4 duration-500 delay-100">
        <div className="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-2 border-green-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Total Completed
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.completedTotal}
              </p>
            </div>
            <div className="text-5xl">‚úÖ</div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-red-500/10 to-orange-500/10 border-2 border-red-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Urgent Done
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.completedUrgent}
              </p>
            </div>
            <div className="text-5xl">üî•</div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-2 border-blue-500/30 rounded-2xl p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-bold text-muted-foreground mb-1">
                Normal Done
              </p>
              <p className="text-4xl font-black text-foreground">
                {stats.completedNormal}
              </p>
            </div>
            <div className="text-5xl">üìù</div>
          </div>
        </div>
      </div>

      {completedTasks.length > 0 ? (
        <div className="space-y-3">
          {completedTasks.map((task, idx) => (
            <div
              key={task.id}
              className="animate-in fade-in slide-in-from-left-4"
              style={{ animationDelay: `${idx * 50}ms` }}
            >
              <CompletedTaskCard
                task={task}
                isEditing={editingId === task.id}
                onToggleComplete={handleToggleComplete}
                onToggleUrgent={handleToggleUrgent}
                onStartEdit={startEdit}
                onDelete={setDeleteConfirm}
                onSaveEdit={saveEdit}
                onCancelEdit={cancelEdit}
                editData={editData}
                onEditChange={handleEditChange}
              />
            </div>
          ))}
        </div>
      ) : (
        <div className="text-center py-20 animate-in fade-in zoom-in duration-500">
          <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-primary/10 to-purple-500/10 mb-4">
            <span className="text-6xl">üìù</span>
          </div>
          <h3 className="text-2xl font-black text-foreground mb-2">
            No completed tasks yet
          </h3>
          <p className="text-muted-foreground font-bold">
            Complete some tasks to see them here! üí™
          </p>
        </div>
      )}

      {isLoading && completedTasks.length === 0 && (
        <div className="text-center py-20">
          <div className="inline-block w-10 h-10 border-4 border-green-500/30 border-t-green-500 rounded-full animate-spin" />
        </div>
      )}

      <ConfirmDialog
        isOpen={deleteConfirm !== null}
        onClose={() => setDeleteConfirm(null)}
        onConfirm={handleDelete}
        title="Delete Completed Task"
        description="Are you sure you want to delete this completed task? This action cannot be undone."
        confirmText="Yes, Delete"
        cancelText="Cancel"
        variant="danger"
      />
    </div>
  );
}





// src/components/AuthMethodSelector.tsx
import { useNavigate } from "react-router-dom";
import { useSignIn } from "@clerk/clerk-react";
import { Mail, LogIn } from "lucide-react";

interface AuthMethodSelectorProps {
  onSelectJWT: () => void;
  onSelectClerk: "clerk";
}

export function AuthMethodSelector({
  onSelectJWT,
  onSelectClerk,
}: AuthMethodSelectorProps) {
  const navigate = useNavigate();
  const { signIn, isLoaded } = useSignIn();

  const handleOAuth = async (
    provider: "oauth_google" | "oauth_github" | "oauth_linkedin"
  ) => {
    if (!isLoaded) return;

    try {
      await signIn.authenticateWithRedirect({
        strategy: provider,
        redirectUrl: window.location.origin + "/sso-callback",
        redirectUrlComplete: window.location.origin + "/",
      });
    } catch (err: any) {
      console.error("OAuth error:", err);
    }
  };

  const handleEmailLogin = () => {
    navigate("/auth/login");
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-primary/5 to-purple-500/10 p-4">
      <div className="w-full max-w-md">
        <div className="text-center mb-8 animate-in fade-in slide-in-from-top-4 duration-700">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-primary to-purple-500 mb-6 animate-in zoom-in duration-500 delay-150 shadow-2xl shadow-primary/30">
            <span className="text-4xl">üìù</span>
          </div>
          <h1 className="text-5xl font-black mb-3">
            <span className="bg-gradient-to-r from-primary via-purple-500 to-primary bg-clip-text text-transparent bg-[length:200%_auto] animate-gradient">
              Welcome to Taskaya! üëã
            </span>
          </h1>
          <p className="text-muted-foreground font-bold text-lg">
            Choose how you want to sign in
          </p>
        </div>

        <div className="bg-card border-2 rounded-3xl p-8 shadow-2xl shadow-primary/10 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-100 backdrop-blur-xl space-y-6">
          {/* Email/Password Option */}
          <div className="space-y-3">
            <h2 className="text-xl font-black text-center mb-4">
              Sign in with Email
            </h2>
            <button
              onClick={handleEmailLogin}
              className="w-full py-4 rounded-2xl bg-gradient-to-r from-primary via-purple-500 to-primary text-white font-black text-lg hover:opacity-90 active:scale-95 transition-all shadow-2xl shadow-primary/30 flex items-center justify-center gap-3 bg-[length:200%_auto] animate-gradient"
            >
              <Mail className="w-6 h-6" />
              Continue with Email
            </button>
          </div>

          <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t-2 border-border"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-4 bg-card text-muted-foreground font-bold">
                Or continue with
              </span>
            </div>
          </div>

          {/* Social Login Options */}
          <div className="space-y-3">
            <h2 className="text-xl font-black text-center mb-4">
              Quick Sign In
            </h2>

            <button
              onClick={() => handleOAuth("oauth_google")}
              disabled={!isLoaded}
              className="w-full py-4 rounded-2xl border-2 border-input hover:border-primary hover:bg-primary/5 transition-all flex items-center justify-center gap-3 font-bold disabled:opacity-50 hover:scale-[1.02]"
            >
              <svg className="w-6 h-6" viewBox="0 0 24 24">
                <path
                  fill="currentColor"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="currentColor"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="currentColor"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="currentColor"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Sign in with Google
            </button>

            <button
              onClick={() => handleOAuth("oauth_github")}
              disabled={!isLoaded}
              className="w-full py-4 rounded-2xl border-2 border-input hover:border-primary hover:bg-primary/5 transition-all flex items-center justify-center gap-3 font-bold disabled:opacity-50 hover:scale-[1.02]"
            >
              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
              </svg>
              Sign in with GitHub
            </button>

            <button
              onClick={() => handleOAuth("oauth_linkedin")}
              disabled={!isLoaded}
              className="w-full py-4 rounded-2xl border-2 border-input hover:border-primary hover:bg-primary/5 transition-all flex items-center justify-center gap-3 font-bold disabled:opacity-50 hover:scale-[1.02]"
            >
              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
              </svg>
              Sign in with LinkedIn
            </button>
          </div>

          <div className="mt-6 pt-6 border-t text-center">
            <p className="text-xs text-muted-foreground">
              By continuing, you agree to Taskaya's Terms of Service and Privacy
              Policy
            </p>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes gradient {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-gradient {
          animation: gradient 3s ease infinite;
        }
      `}</style>
    </div>
  );
}




// src/components/AddTask.tsx
import { useState, useCallback, memo } from "react";
import { useAuth } from "@clerk/clerk-react";
import { useAuthStore, useTaskStore } from "@/store";
import {
  Plus,
  Loader2,
  FileText,
  Calendar as CalendarIcon,
  X,
} from "lucide-react";
import { CustomDatePicker } from "./CustomDatePicker";

interface AddTaskProps {
  authMethod: "clerk" | "jwt" | null;
}

export const AddTask = memo(({ authMethod }: AddTaskProps) => {
  const { getToken } = useAuth();
  const { token: jwtToken } = useAuthStore();
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [deadline, setDeadline] = useState("");
  const [isUrgent, setIsUrgent] = useState(false);
  const [showDescription, setShowDescription] = useState(false);
  const [showCalendar, setShowCalendar] = useState(false);
  const { addTask, isLoading } = useTaskStore();

  const handleSubmit = useCallback(
    async (e: React.FormEvent) => {
      e.preventDefault();
      const trimmedTitle = title.trim();

      if (!trimmedTitle) return;

      try {
        let token: string | null = null;

        // Get token based on auth method
        if (authMethod === "clerk") {
          token = await getToken();
        } else if (authMethod === "jwt") {
          token = jwtToken;
        }

        if (!token) {
          console.error("No token available");
          return;
        }

        await addTask(
          token,
          trimmedTitle,
          description.trim() || undefined,
          deadline || undefined,
          isUrgent
        );

        // Reset form
        setTitle("");
        setDescription("");
        setDeadline("");
        setIsUrgent(false);
        setShowDescription(false);
        setShowCalendar(false);
      } catch (error) {
        console.error("Failed to add task:", error);
      }
    },
    [title, description, deadline, isUrgent, addTask, getToken, authMethod, jwtToken]
  );

  const handleClearDeadline = useCallback(() => {
    setDeadline("");
  }, []);

  const toggleDescription = useCallback(() => {
    setShowDescription((prev) => !prev);
  }, []);

  const toggleCalendar = useCallback(() => {
    setShowCalendar((prev) => !prev);
  }, []);

  const toggleUrgent = useCallback(() => {
    setIsUrgent((prev) => !prev);
  }, []);

  return (
    <div className="p-6 border-b bg-gradient-to-br from-card/50 to-primary/5 backdrop-blur-sm">
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Main Input Row */}
        <div className="flex gap-3">
          <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="‚ú® Add a new task..."
            className="flex-1 px-6 py-4 rounded-2xl bg-background border-2 border-input focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all duration-200 placeholder:text-muted-foreground font-bold text-lg shadow-lg"
            disabled={isLoading}
          />

          <button
            type="button"
            onClick={toggleDescription}
            className={`p-4 rounded-2xl border-2 transition-all duration-200 shadow-lg hover:scale-105 ${
              showDescription
                ? "bg-gradient-to-br from-primary to-purple-500 text-white border-primary"
                : "bg-background text-muted-foreground hover:text-foreground hover:border-primary/50 border-input"
            }`}
            disabled={isLoading}
            title="Add Description"
          >
            <FileText className="w-6 h-6" />
          </button>

          <button
            type="button"
            onClick={toggleCalendar}
            className={`p-4 rounded-2xl border-2 transition-all duration-200 shadow-lg hover:scale-105 ${
              showCalendar || deadline
                ? "bg-gradient-to-br from-primary to-purple-500 text-white border-primary"
                : "bg-background text-muted-foreground hover:text-foreground hover:border-primary/50 border-input"
            }`}
            disabled={isLoading}
            title="Set Deadline"
          >
            <CalendarIcon className="w-6 h-6" />
          </button>

          <button
            type="submit"
            disabled={isLoading || !title.trim()}
            className="px-8 py-4 rounded-2xl bg-gradient-to-r from-primary via-purple-500 to-primary text-white font-black text-lg hover:opacity-90 active:scale-95 transition-all duration-200 shadow-xl shadow-primary/30 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-3 bg-[length:200%_auto] animate-gradient"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-6 h-6 animate-spin" />
                Adding...
              </>
            ) : (
              <>
                <Plus className="w-6 h-6" />
                Add
              </>
            )}
          </button>
        </div>

        {/* Description Field */}
        {showDescription && (
          <div className="animate-in slide-in-from-top-4 duration-300">
            <div className="relative">
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Add description... (optional)"
                rows={3}
                className="w-full px-6 py-4 pr-12 rounded-2xl bg-background border-2 border-input focus:border-primary focus:ring-4 focus:ring-primary/20 outline-none transition-all duration-200 placeholder:text-muted-foreground resize-none shadow-lg font-semibold"
                disabled={isLoading}
              />
              <button
                type="button"
                onClick={() => {
                  setDescription("");
                  setShowDescription(false);
                }}
                className="absolute top-4 right-4 p-1 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all"
              >
                <X className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}

        {/* Calendar and Urgent Row */}
        {showCalendar && (
          <div className="flex gap-3 animate-in slide-in-from-top-4 duration-300">
            <div className="flex-1">
              <CustomDatePicker
                value={deadline}
                onChange={setDeadline}
                disabled={isLoading}
              />
            </div>
            <button
              type="button"
              onClick={toggleUrgent}
              className={`px-8 py-4 rounded-2xl border-2 transition-all duration-200 flex items-center gap-3 font-black text-lg shadow-lg hover:scale-105 ${
                isUrgent
                  ? "bg-gradient-to-r from-red-500 to-orange-500 text-white border-red-500 animate-pulse"
                  : "bg-background text-muted-foreground hover:text-foreground hover:border-red-500/50 border-input"
              }`}
              disabled={isLoading}
            >
              <span>{isUrgent ? "üî• URGENT" : "‚≠ê Normal"}</span>
            </button>
          </div>
        )}

        {/* Selected Deadline Display */}
        {deadline && !showCalendar && (
          <div className="flex items-center gap-2 px-4 py-2 bg-primary/10 border border-primary/30 rounded-xl animate-in fade-in duration-300">
            <CalendarIcon className="w-4 h-4 text-primary" />
            <span className="text-sm font-bold text-primary flex-1">
              Deadline: {new Date(deadline).toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              })}
            </span>
            <button
              type="button"
              onClick={handleClearDeadline}
              className="p-1 rounded hover:bg-destructive/10 hover:text-destructive transition-all"
            >
              <X className="w-3 h-3" />
            </button>
          </div>
        )}
      </form>

      <style>{`
        @keyframes gradient {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        
        .animate-gradient {
          animation: gradient 3s ease infinite;
        }
      `}</style>
    </div>
  );
});

AddTask.displayName = "AddTask";




import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }





import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}




// src/components/layouts/MainLayout.tsx - FIXED: Pass auth context properly
import { useState, useEffect } from "react";
import { Outlet, useNavigate, useLocation } from "react-router-dom";
import { Side } from "../Side";
import { AddTask } from "../AddTask";
import { Search } from "../Search";

interface MainLayoutProps {
  authMethod: "clerk" | "jwt" | null;
}

export function MainLayout({ authMethod }: MainLayoutProps) {
  const navigate = useNavigate();
  const location = useLocation();

  console.log("üè† MainLayout - Auth Method:", authMethod);

  // Determine active view based on current route
  const getActiveView = (): "all" | "completed" | "urgent" => {
    if (location.pathname === "/completed") return "completed";
    if (location.pathname === "/urgent") return "urgent";
    return "all";
  };

  const [activeView, setActiveView] = useState<"all" | "completed" | "urgent">(
    getActiveView()
  );

  // Update active view when location changes
  useEffect(() => {
    setActiveView(getActiveView());
  }, [location.pathname]);

  // Handle view change with navigation
  const handleViewChange = (view: "all" | "completed" | "urgent") => {
    console.log("üìç View changing to:", view);
    setActiveView(view);

    switch (view) {
      case "all":
        navigate("/");
        break;
      case "completed":
        navigate("/completed");
        break;
      case "urgent":
        navigate("/urgent");
        break;
    }
  };

  return (
    <div className="flex h-screen bg-background">
      {/* Sidebar */}
      <Side activeView={activeView} onViewChange={handleViewChange} />

      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden lg:ml-0 pt-16 lg:pt-0">
        {/* Search Section */}
        <Search authMethod={authMethod} />

        {/* Add Task Section */}
        <AddTask authMethod={authMethod} />

        {/* Content Area - Outlet for nested routes with context */}
        <Outlet context={{ authMethod }} />
      </div>
    </div>
  );
}




{
  "name": "taskaya-backend",
  "version": "1.0.0",
  "description": "Task management API with Prisma and authentication",
  "main": "dist/server.js",
  "scripts": {
    "dev": "concurrently -n \"BACKEND,FRONTEND\" -c \"bgBlue.bold,bgMagenta.bold\" \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "ts-node-dev --respawn --transpile-only src/server.ts",
    "dev:frontend": "cd ../frontend && npm run dev",
    "build": "tsc",
    "start": "concurrently -n \"BACKEND,FRONTEND\" -c \"bgBlue.bold,bgMagenta.bold\" \"npm run start:backend\" \"npm run start:frontend\"",
    "start:backend": "ts-node-dev --respawn --transpile-only src/server.ts",
    "start:frontend": "cd ../frontend && npm run dev",
    "serve": "node dist/server.js",
    "clean": "rm -rf dist",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:migrate:prod": "prisma migrate deploy",
    "prisma:studio": "prisma studio",
    "prisma:seed": "ts-node prisma/seed.ts",
    "prisma:reset": "prisma migrate reset",
    "db:push": "prisma db push",
    "postinstall": "prisma generate"
  },
  "keywords": [
    "express",
    "typescript",
    "prisma",
    "postgresql",
    "api",
    "taskaya"
  ],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@clerk/clerk-sdk-node": "^4.13.23",
    "@prisma/client": "^5.22.0",
    "bcrypt": "^5.1.1",
    "cors": "^2.8.5",
    "dotenv": "^16.6.1",
    "express": "^4.22.1",
    "express-validator": "^7.3.1",
    "jsonwebtoken": "^9.0.3",
    "pg": "^8.16.3"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/jsonwebtoken": "^9.0.6",
    "@types/node": "^20.14.9",
    "concurrently": "^8.2.2",
    "prisma": "^5.22.0",
    "ts-node": "^10.9.2",
    "ts-node-dev": "^2.0.0",
    "typescript": "^5.9.3"
  }
}





// backend/src/utils/cleanupTokens.ts
import { prisma } from "../config/db";

export const cleanupExpiredTokens = async (): Promise<void> => {
  try {
    const result = await prisma.refreshToken.deleteMany({
      where: {
        OR: [
          { expiresAt: { lt: new Date() } },
          {
            revoked: true,
            createdAt: { lt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) },
          },
        ],
      },
    });

    if (result.count > 0) {
      console.log(`üßπ Cleaned up ${result.count} expired/revoked tokens`);
    }
  } catch (error) {
    console.error("‚ùå Error cleaning up tokens:", error);
  }
};

export const startTokenCleanup = (): void => {
  console.log("üîÑ Token cleanup service started");
  cleanupExpiredTokens();
  setInterval(() => {
    cleanupExpiredTokens();
  }, 24 * 60 * 60 * 1000);
};





// src/server.ts
import app from "./app";
import { initDB } from "./config/db";
import dotenv from "dotenv";

dotenv.config();

const PORT = process.env.PORT || 5000;

const startServer = async (): Promise<void> => {
  try {
    // Initialize database
    await initDB();

    // TODO: Add token cleanup service later
    // startTokenCleanup();

    // Start server
    app.listen(PORT, () => {
      console.log(`üöÄ Server running on http://localhost:${PORT}`);
      console.log(`üìù API Documentation:`);
      console.log(`   Authentication:`);
      console.log(`   - POST /api/auth/register       - Register new user`);
      console.log(`   - POST /api/auth/login          - Login user`);
      console.log(`   - POST /api/auth/refresh        - Refresh access token`);
      console.log(`   - POST /api/auth/logout         - Logout (revoke token)`);
      console.log(
        `   - POST /api/auth/logout-all     - Logout from all devices`
      );
      console.log(`   Tasks:`);
      console.log(`   - GET  /api/tasks               - Get all tasks`);
      console.log(`   - POST /api/tasks               - Create new task`);
      console.log(`   - GET  /api/tasks/completed     - Get completed tasks`);
      console.log(`   - GET  /api/tasks/urgent        - Get urgent tasks`);
      console.log(`   - GET  /api/tasks/search?q=...  - Search tasks`);
      console.log(`   - PUT  /api/tasks/:id           - Update task`);
      console.log(`   - DELETE /api/tasks/:id         - Delete task`);
    });
  } catch (error) {
    console.error("‚ùå Failed to start server:", error);
    process.exit(1);
  }
};

startServer();





// src/app.ts
import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import authRoutes from "./routes/auth.routes";
import taskRoutes from "./routes/task.routes";

dotenv.config();

const app = express();

// CORS configuration
app.use(
  cors({
    origin: process.env.FRONTEND_URL || "http://localhost:5173",
    credentials: true,
  })
);

app.use(express.json());

// Health check
app.get("/", (_req, res) => {
  res.json({
    message: "Taskaya API is running",
    version: "3.0.0",
    authentication: "Clerk + JWT",
    endpoints: {
      auth: "/api/auth",
      tasks: "/api/tasks",
    },
  });
});

// Routes
app.use("/api/auth", authRoutes); // Traditional auth
app.use("/api/tasks", taskRoutes); // Tasks (supports both auth methods)

// 404 handler
app.use((_req, res) => {
  res.status(404).json({ error: "Route not found" });
});

// Error handler
app.use((err: any, _req: express.Request, res: express.Response, _next: express.NextFunction) => {
  console.error("Error:", err);
  res.status(err.status || 500).json({
    error: err.message || "Internal server error",
    ...(process.env.NODE_ENV === "development" && { stack: err.stack }),
  });
});

export default app;




// backend/src/routes/task.routes.ts - ENHANCED
import { Router } from "express";
import { clerkAuth, extractClerkUser } from "../middleware/clerk.middleware";
import { jwtAuth } from "../middleware/jwt.middleware";
import {
  createTaskValidator,
  updateTaskValidator,
  deleteTaskValidator,
  searchTasksValidator,
} from "../middleware/validation.middleware";
import {
  addTask,
  getTasks,
  updateTask,
  deleteTask,
  getCompletedTasks,
  getUrgentTasks,
  searchTasks,
} from "../controllers/task.controller";

const router = Router();

/**
 * Smart Authentication Middleware
 * Automatically detects whether the token is from Clerk or JWT
 * and applies the appropriate authentication middleware
 */
const smartAuth = (req: any, res: any, next: any) => {
  const authHeader = req.headers.authorization;

  if (!authHeader) {
    return res.status(401).json({ error: "No authentication token provided" });
  }

  const token = authHeader.split(" ")[1];

  if (!token) {
    return res
      .status(401)
      .json({ error: "Invalid authorization header format" });
  }

  try {
    // Decode token WITHOUT verification to check its structure
    const parts = token.split(".");
    if (parts.length !== 3) {
      return res.status(401).json({ error: "Invalid token format" });
    }

    const decoded: any = JSON.parse(Buffer.from(parts[1], "base64").toString());

    // Clerk tokens have specific fields: 'azp', 'sid', 'sub'
    // JWT tokens have: 'id', 'email', 'iat', 'exp'
    const isClerkToken = !!(
      decoded.azp ||
      decoded.sid ||
      (decoded.sub && !decoded.id)
    );
    const isJWTToken = !!(decoded.id && decoded.email);

    if (isClerkToken) {
      console.log("üîµ Detected Clerk token - applying Clerk auth");
      return clerkAuth(req, res, (err?: any) => {
        if (err) return next(err);
        return extractClerkUser(req, res, next);
      });
    } else if (isJWTToken) {
      console.log("üü¢ Detected JWT token - applying JWT auth");
      return jwtAuth(req, res, next);
    } else {
      console.log("‚ùå Unknown token format");
      return res.status(401).json({ error: "Unrecognized token format" });
    }
  } catch (error) {
    console.error("‚ùå Token parsing error:", error);
    return res.status(401).json({ error: "Invalid token" });
  }
};

// Apply smart auth to all routes
router.use(smartAuth);

// ============= TASK ROUTES =============

// Get all tasks
router.get("/", getTasks);

// Create new task
router.post("/", createTaskValidator, addTask);

// Get completed tasks ONLY
router.get("/completed", getCompletedTasks);

// Get ALL urgent tasks (completed and incomplete)
router.get("/urgent", getUrgentTasks);

// Search tasks
router.get("/search", searchTasksValidator, searchTasks);

// Update task
router.put("/:id", updateTaskValidator, updateTask);

// Delete task
router.delete("/:id", deleteTaskValidator, deleteTask);

export default router;





// src/routes/auth.routes.ts
import { Router } from "express";
import { register, login, refreshToken, logout, logoutAll } from "../controllers/auth.controller";

const router = Router();

router.post("/register", register);
router.post("/login", login);
router.post("/refresh", refreshToken);
router.post("/logout", logout);
router.post("/logout-all", logoutAll);

export default router;




// src/middleware/validation.middleware.ts - FIXED
import { body, param, query, validationResult } from "express-validator";
import { Request, Response, NextFunction } from "express";

// Validation error handler
export const handleValidationErrors = (
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    res.status(400).json({
      error: "Validation failed",
      details: errors.array().map((err) => ({
        field: err.type === "field" ? err.path : undefined,
        message: err.msg,
      })),
    });
    return;
  }
  next();
};

// Auth Validators - FIXED: Removed Gmail-only restriction
export const registerValidator = [
  body("email")
    .trim()
    .notEmpty()
    .withMessage("Email is required")
    .isEmail()
    .withMessage("Invalid email format")
    .normalizeEmail(),
  body("password")
    .trim()
    .notEmpty()
    .withMessage("Password is required")
    .isLength({ min: 6, max: 100 })
    .withMessage("Password must be between 6 and 100 characters")
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage("Password must contain uppercase, lowercase, and number"),
  handleValidationErrors,
];

export const loginValidator = [
  body("email")
    .trim()
    .notEmpty()
    .withMessage("Email is required")
    .isEmail()
    .withMessage("Invalid email format")
    .normalizeEmail(),
  body("password").trim().notEmpty().withMessage("Password is required"),
  handleValidationErrors,
];

export const refreshTokenValidator = [
  body("refreshToken")
    .trim()
    .notEmpty()
    .withMessage("Refresh token is required"),
  handleValidationErrors,
];

export const logoutValidator = [
  body("refreshToken")
    .trim()
    .notEmpty()
    .withMessage("Refresh token is required"),
  handleValidationErrors,
];

// Task Validators
export const createTaskValidator = [
  body("title")
    .trim()
    .notEmpty()
    .withMessage("Title is required")
    .isLength({ min: 1, max: 500 })
    .withMessage("Title must be between 1 and 500 characters"),
  body("description")
    .optional({ nullable: true })
    .trim()
    .isLength({ max: 2000 })
    .withMessage("Description cannot exceed 2000 characters"),
  body("deadline")
    .optional({ nullable: true })
    .isISO8601()
    .withMessage("Invalid date format")
    .custom((value) => {
      if (value && new Date(value) < new Date()) {
        throw new Error("Deadline cannot be in the past");
      }
      return true;
    }),
  body("is_urgent")
    .optional()
    .isBoolean()
    .withMessage("is_urgent must be a boolean"),
  handleValidationErrors,
];

export const updateTaskValidator = [
  param("id").isInt({ min: 1 }).withMessage("Invalid task ID"),
  body("title")
    .optional()
    .trim()
    .notEmpty()
    .withMessage("Title cannot be empty")
    .isLength({ min: 1, max: 500 })
    .withMessage("Title must be between 1 and 500 characters"),
  body("description")
    .optional({ nullable: true })
    .trim()
    .isLength({ max: 2000 })
    .withMessage("Description cannot exceed 2000 characters"),
  body("deadline")
    .optional({ nullable: true })
    .isISO8601()
    .withMessage("Invalid date format"),
  body("is_urgent")
    .optional()
    .isBoolean()
    .withMessage("is_urgent must be a boolean"),
  body("completed")
    .optional()
    .isBoolean()
    .withMessage("completed must be a boolean"),
  body("status")
    .optional()
    .isIn(["pending", "in_progress", "completed"])
    .withMessage("Invalid status value"),
  handleValidationErrors,
];

export const deleteTaskValidator = [
  param("id").isInt({ min: 1 }).withMessage("Invalid task ID"),
  handleValidationErrors,
];

export const searchTasksValidator = [
  query("q")
    .trim()
    .notEmpty()
    .withMessage("Search query is required")
    .isLength({ min: 1, max: 200 })
    .withMessage("Search query must be between 1 and 200 characters"),
  handleValidationErrors,
];




// backend/src/middleware/jwt.middleware.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";

const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key";

export interface JWTRequest extends Request {
  userId?: number;
  userEmail?: string;
}

interface JwtPayload {
  id: number;
  email: string;
}

export const jwtAuth = (
  req: JWTRequest,
  res: Response,
  next: NextFunction
): void => {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader) {
      res.status(401).json({ error: "No token provided" });
      return;
    }

    const token = authHeader.split(" ")[1];

    if (!token) {
      res.status(401).json({ error: "Invalid token format" });
      return;
    }

    console.log("üîê Verifying JWT token...");

    const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;
    req.userId = decoded.id;
    req.userEmail = decoded.email;

    console.log("‚úÖ JWT token verified for user:", decoded.email);

    next();
  } catch (error) {
    console.error("‚ùå JWT authentication error:", error);
    
    if (error instanceof jwt.JsonWebTokenError) {
      res.status(401).json({ error: "Invalid token" });
      return;
    }
    if (error instanceof jwt.TokenExpiredError) {
      res.status(401).json({ error: "Token expired" });
      return;
    }
    res.status(500).json({ error: "Internal server error" });
  }
};



// src/middleware/dual-auth.middleware.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";
import { clerkClient } from "@clerk/clerk-sdk-node";
import { prisma } from "../config/db";

const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key";

export interface DualAuthRequest extends Request {
  userId?: number;
  clerkUserId?: string;
  authMethod?: "jwt" | "clerk";
}

interface JwtPayload {
  id: number;
  email: string;
}

/**
 * Middleware that supports both JWT and Clerk authentication
 * Priority: Clerk > JWT
 */
export const dualAuth = async (
  req: DualAuthRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader) {
      res.status(401).json({ error: "No token provided" });
      return;
    }

    const token = authHeader.split(" ")[1];

    if (!token) {
      res.status(401).json({ error: "Invalid token format" });
      return;
    }

    // Try Clerk authentication first
    try {
      const clerkSession = await clerkClient.verifyToken(token, {
        secretKey: process.env.CLERK_SECRET_KEY,
      });

      if (clerkSession && clerkSession.sub) {
        console.log("‚úÖ Clerk authentication successful");
        const clerkUserId = clerkSession.sub;
        req.clerkUserId = clerkUserId;
        req.authMethod = "clerk";

        // Get or create user in database
        let user = await prisma.user.findUnique({
          where: { clerkId: clerkUserId },
          select: { id: true, email: true, clerkId: true },
        });

        if (!user) {
          console.log("üìù Creating new user from Clerk...");
          const clerkUser = await clerkClient.users.getUser(clerkUserId);

          const primaryEmail = clerkUser.emailAddresses.find(
            (e) => e.id === clerkUser.primaryEmailAddressId
          );

          if (!primaryEmail) {
            res.status(400).json({ error: "No email address found" });
            return;
          }

          user = await prisma.user.create({
            data: {
              clerkId: clerkUserId,
              email: primaryEmail.emailAddress,
              name: clerkUser.firstName
                ? `${clerkUser.firstName} ${clerkUser.lastName || ""}`.trim()
                : null,
              imageUrl: clerkUser.imageUrl,
            },
            select: { id: true, email: true, clerkId: true },
          });

          console.log("‚úÖ User created:", user.email);
        }

        req.userId = user.id;
        return next();
      }
    } catch (clerkError) {
      console.log("‚ö†Ô∏è Clerk auth failed, trying JWT...");
    }

    // Fallback to JWT authentication
    try {
      const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;
      console.log("‚úÖ JWT authentication successful");
      req.userId = decoded.id;
      req.authMethod = "jwt";
      return next();
    } catch (jwtError) {
      console.error("‚ùå JWT auth failed:", jwtError);
      res.status(401).json({ error: "Invalid or expired token" });
      return;
    }
  } catch (error) {
    console.error("‚ùå Authentication error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};





// backend/src/middleware/clerk.middleware.ts
import { Request, Response, NextFunction } from "express";
import { ClerkExpressRequireAuth } from "@clerk/clerk-sdk-node";
import { prisma } from "../config/db";

export interface ClerkRequest extends Request {
  auth?: {
    userId: string;
    sessionId: string;
    orgId?: string;
  };
  userId?: number;
  clerkUserId?: string;
}

// Clerk authentication middleware
export const clerkAuth = ClerkExpressRequireAuth({
  onError: (error) => {
    console.error("‚ùå Clerk authentication error:", error);
    return {
      status: 401,
      message: "Unauthorized - Invalid or missing Clerk token",
    };
  },
});

// Middleware to sync Clerk user with database
export const extractClerkUser = async (
  req: ClerkRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    if (!req.auth || !req.auth.userId) {
      res.status(401).json({ error: "Unauthorized - No Clerk user ID found" });
      return;
    }

    const clerkUserId = req.auth.userId;
    req.clerkUserId = clerkUserId;

    console.log("üîç Processing Clerk User ID:", clerkUserId);

    // Check if user exists in database
    let user = await prisma.user.findUnique({
      where: { clerkId: clerkUserId },
      select: { id: true, email: true, clerkId: true, name: true, imageUrl: true },
    });

    // If user doesn't exist, create them from Clerk data
    if (!user) {
      console.log("üìù Creating new Clerk user in database...");

      // Get user info from Clerk
      const { clerkClient } = await import("@clerk/clerk-sdk-node");
      const clerkUser = await clerkClient.users.getUser(clerkUserId);

      const primaryEmail = clerkUser.emailAddresses.find(
        (e) => e.id === clerkUser.primaryEmailAddressId
      );

      if (!primaryEmail) {
        res.status(400).json({ error: "No email address found in Clerk account" });
        return;
      }

      // Check if email already exists (from JWT user)
      const existingEmailUser = await prisma.user.findUnique({
        where: { email: primaryEmail.emailAddress.toLowerCase() },
      });

      if (existingEmailUser) {
        res.status(409).json({ 
          error: "This email is already registered. Please sign in with email/password instead." 
        });
        return;
      }

      user = await prisma.user.create({
        data: {
          clerkId: clerkUserId,
          email: primaryEmail.emailAddress.toLowerCase(),
          name: clerkUser.firstName
            ? `${clerkUser.firstName} ${clerkUser.lastName || ""}`.trim()
            : null,
          imageUrl: clerkUser.imageUrl,
          password: null, // Clerk users don't have password
        },
        select: { id: true, email: true, clerkId: true, name: true, imageUrl: true },
      });

      console.log("‚úÖ Clerk user created in database:", user.email);
    } else {
      console.log("‚úÖ Clerk user found in database:", user.email);
    }

    // Attach database user ID to request
    req.userId = user.id;

    next();
  } catch (error) {
    console.error("‚ùå Extract Clerk user error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};




  // src/middleware/auth.middleware.ts
  import { Request, Response, NextFunction } from "express";
  import jwt from "jsonwebtoken";

  const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key-change-in-production";

  export interface AuthRequest extends Request {
    userId?: number;
  }

  interface JwtPayload {
    id: number;
    email: string;
  }

  export const auth = (
    req: AuthRequest,
    res: Response,
    next: NextFunction
  ): void => {
    try {
      const authHeader = req.headers.authorization;

      if (!authHeader) {
        res.status(401).json({ error: "No token provided" });
        return;
      }

      const token = authHeader.split(" ")[1];

      if (!token) {
        res.status(401).json({ error: "Invalid token format" });
        return;
      }

      const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;
      req.userId = decoded.id;

      next();
    } catch (error) {
      if (error instanceof jwt.JsonWebTokenError) {
        res.status(401).json({ error: "Invalid token" });
        return;
      }
      if (error instanceof jwt.TokenExpiredError) {
        res.status(401).json({ error: "Token expired" });
        return;
      }
      res.status(500).json({ error: "Internal server error" });
    }
  };





// src/controllers/task.controller.ts - ENHANCED
import { Response } from "express";
import { prisma } from "../config/db";
import { ClerkRequest } from "../middleware/clerk.middleware";

// Add a new task
export const addTask = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    console.log("========= ADD TASK DEBUG =========");
    console.log("1. Request Body:", req.body);
    console.log("2. User ID (Database):", req.userId);
    console.log("3. Clerk User ID:", req.clerkUserId);

    const { title, description, deadline, is_urgent } = req.body;

    if (!title || typeof title !== "string" || !title.trim()) {
      console.log("‚ùå Error: Title is missing or invalid");
      res.status(400).json({ error: "Title is required" });
      return;
    }

    if (!req.userId) {
      console.log("‚ùå Error: User ID is missing");
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    console.log("4. Creating task with data:", {
      userId: req.userId,
      title: title.trim(),
      description: description?.trim() || null,
      deadline: deadline ? new Date(deadline) : null,
      isUrgent: is_urgent || false,
      status: "pending",
    });

    const task = await prisma.task.create({
      data: {
        userId: req.userId,
        title: title.trim(),
        description: description?.trim() || null,
        deadline: deadline ? new Date(deadline) : null,
        isUrgent: is_urgent || false,
        status: "pending",
      },
    });

    console.log("‚úÖ Task created successfully:", task);
    console.log("==================================");

    res.status(201).json({ message: "Task created successfully", task });
  } catch (error) {
    console.error("========= ADD TASK ERROR =========");
    console.error("Error details:", error);

    if (error instanceof Error) {
      console.error("Error message:", error.message);
      console.error("Error stack:", error.stack);
    }

    console.error("==================================");

    res.status(500).json({
      error: "Internal server error",
      details: process.env.NODE_ENV === "development" ? error : undefined,
    });
  }
};

// Get all tasks for user
export const getTasks = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    console.log("========= GET TASKS DEBUG =========");
    console.log("User ID:", req.userId);

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    const tasks = await prisma.task.findMany({
      where: { userId: req.userId },
      orderBy: [
        { completed: "asc" },
        { isUrgent: "desc" },
        { createdAt: "desc" },
      ],
    });

    console.log("‚úÖ Tasks found:", tasks.length);
    console.log("==================================");

    res.json({ tasks, count: tasks.length });
  } catch (error) {
    console.error("Get tasks error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

// Update a task
export const updateTask = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    const { id } = req.params;
    const { title, description, deadline, is_urgent, completed, status } =
      req.body;

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    if (isNaN(parseInt(id))) {
      res.status(400).json({ error: "Invalid task ID" });
      return;
    }

    const task = await prisma.task.findFirst({
      where: { id: parseInt(id), userId: req.userId },
    });

    if (!task) {
      res.status(404).json({ error: "Task not found" });
      return;
    }

    const updatedTask = await prisma.task.update({
      where: { id: parseInt(id) },
      data: {
        ...(title !== undefined && { title: title.trim() }),
        ...(description !== undefined && {
          description: description?.trim() || null,
        }),
        ...(deadline !== undefined && {
          deadline: deadline ? new Date(deadline) : null,
        }),
        ...(is_urgent !== undefined && { isUrgent: is_urgent }),
        ...(completed !== undefined && { completed }),
        ...(status !== undefined && { status }),
      },
    });

    res.json({ message: "Task updated successfully", task: updatedTask });
  } catch (error) {
    console.error("Update task error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

// Delete a task
export const deleteTask = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    const { id } = req.params;

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    if (isNaN(parseInt(id))) {
      res.status(400).json({ error: "Invalid task ID" });
      return;
    }

    const task = await prisma.task.findFirst({
      where: { id: parseInt(id), userId: req.userId },
    });

    if (!task) {
      res.status(404).json({ error: "Task not found" });
      return;
    }

    await prisma.task.delete({ where: { id: parseInt(id) } });

    res.json({ message: "Task deleted successfully" });
  } catch (error) {
    console.error("Delete task error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

// Get completed tasks - FIXED: Only return completed tasks
export const getCompletedTasks = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    console.log("‚úÖ Fetching ONLY completed tasks");

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    const tasks = await prisma.task.findMany({
      where: {
        userId: req.userId,
        completed: true, // FIXED: Only completed tasks
      },
      orderBy: { updatedAt: "desc" },
    });

    console.log("‚úÖ Completed tasks found:", tasks.length);
    res.json({ tasks, count: tasks.length });
  } catch (error) {
    console.error("Get completed tasks error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

// Get urgent tasks - FIXED: Return ALL urgent tasks (completed and incomplete)
export const getUrgentTasks = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    console.log("üî• Fetching ALL urgent tasks");

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    const tasks = await prisma.task.findMany({
      where: {
        userId: req.userId,
        isUrgent: true, // FIXED: All urgent, regardless of completion
      },
      orderBy: [
        { completed: "asc" }, // Incomplete first
        { createdAt: "desc" },
      ],
    });

    console.log("‚úÖ Urgent tasks found:", tasks.length);
    res.json({ tasks, count: tasks.length });
  } catch (error) {
    console.error("Get urgent tasks error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

// Search tasks
export const searchTasks = async (
  req: ClerkRequest,
  res: Response
): Promise<void> => {
  try {
    const { q } = req.query;

    if (!req.userId) {
      res.status(401).json({ error: "User not authenticated" });
      return;
    }

    if (!q || typeof q !== "string" || !q.trim()) {
      res.status(400).json({ error: "Search query is required" });
      return;
    }

    const tasks = await prisma.task.findMany({
      where: {
        userId: req.userId,
        OR: [
          { title: { contains: q.trim(), mode: "insensitive" } },
          { description: { contains: q.trim(), mode: "insensitive" } },
        ],
      },
      orderBy: { createdAt: "desc" },
    });

    res.json({ tasks, count: tasks.length, query: q.trim() });
  } catch (error) {
    console.error("Search tasks error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};





// backend/src/controllers/auth.controller.ts
import { Request, Response } from "express";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import { prisma } from "../config/db";

const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key";
const JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || "your-refresh-secret-key";
const SALT_ROUNDS = 10;

// Generate Access Token (15 minutes)
const generateAccessToken = (userId: number, email: string): string => {
  return jwt.sign({ id: userId, email }, JWT_SECRET, {
    expiresIn: "15m",
  });
};

// Generate Refresh Token (30 days)
const generateRefreshToken = (userId: number, email: string): string => {
  return jwt.sign({ id: userId, email }, JWT_REFRESH_SECRET, {
    expiresIn: "30d",
  });
};

export const register = async (req: Request, res: Response): Promise<void> => {
  try {
    const { email, password } = req.body;

    console.log("üìù JWT Registration attempt for:", email);

    if (!email || !password) {
      res.status(400).json({ error: "Email and password are required" });
      return;
    }

    // Validate email format (any valid email)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      res.status(400).json({ error: "Please use a valid email address" });
      return;
    }

    // Password validation
    if (password.length < 6) {
      res.status(400).json({ error: "Password must be at least 6 characters" });
      return;
    }

    // Check if user exists
    const existingUser = await prisma.user.findUnique({
      where: { email: email.toLowerCase() },
    });

    if (existingUser) {
      console.log("‚ùå User already exists:", email);
      res.status(409).json({ error: "User already exists" });
      return;
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);
    console.log("üîê Password hashed successfully");

    // Create user (without clerkId)
    const user = await prisma.user.create({
      data: {
        email: email.toLowerCase(),
        password: hashedPassword,
        clerkId: null, // JWT users don't have clerkId
      },
      select: {
        id: true,
        email: true,
        createdAt: true,
      },
    });

    console.log("‚úÖ JWT User created successfully:", user.email);

    // Generate tokens
    const accessToken = generateAccessToken(user.id, user.email);
    const refreshToken = generateRefreshToken(user.id, user.email);

    // Store refresh token in database
    await prisma.refreshToken.create({
      data: {
        token: refreshToken,
        userId: user.id,
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
      },
    });

    res.status(201).json({
      message: "User registered successfully",
      accessToken,
      refreshToken,
      user,
      authMethod: "jwt",
    });
  } catch (error) {
    console.error("Register error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

export const login = async (req: Request, res: Response): Promise<void> => {
  try {
    const { email, password } = req.body;

    console.log("========= JWT LOGIN DEBUG =========");
    console.log("1. Login attempt for email:", email);

    if (!email || !password) {
      console.log("‚ùå Missing email or password");
      res.status(400).json({ error: "Email and password are required" });
      return;
    }

    // Find user (only JWT users - those without clerkId or with null clerkId)
    const user = await prisma.user.findFirst({
      where: { 
        email: email.toLowerCase(),
        OR: [
          { clerkId: null },
          { password: { not: null } }
        ]
      },
    });

    console.log("2. User found in DB:", !!user);

    if (!user || !user.password) {
      console.log("‚ùå User not found or is a Clerk user");
      res.status(401).json({ 
        error: "Invalid credentials. If you signed up with Google/GitHub/LinkedIn, please use those methods to sign in." 
      });
      return;
    }

    // Verify password
    console.log("3. Comparing passwords...");
    const validPassword = await bcrypt.compare(password, user.password);
    console.log("4. Password valid:", validPassword);

    if (!validPassword) {
      console.log("‚ùå Invalid password");
      res.status(401).json({ error: "Invalid credentials" });
      return;
    }

    console.log("‚úÖ JWT Login successful!");

    // Generate tokens
    const accessToken = generateAccessToken(user.id, user.email);
    const refreshToken = generateRefreshToken(user.id, user.email);

    // Store refresh token in database
    await prisma.refreshToken.create({
      data: {
        token: refreshToken,
        userId: user.id,
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      },
    });

    console.log("üéâ Tokens generated and stored");
    console.log("==================================");

    res.json({
      message: "Login successful",
      accessToken,
      refreshToken,
      user: {
        id: user.id,
        email: user.email,
      },
      authMethod: "jwt",
    });
  } catch (error) {
    console.error("========= JWT LOGIN ERROR =========");
    console.error("Login error:", error);
    console.error("==================================");
    res.status(500).json({ error: "Internal server error" });
  }
};

export const refreshToken = async (req: Request, res: Response): Promise<void> => {
  try {
    const { refreshToken } = req.body;

    if (!refreshToken) {
      res.status(400).json({ error: "Refresh token is required" });
      return;
    }

    // Verify refresh token
    let decoded;
    try {
      decoded = jwt.verify(refreshToken, JWT_REFRESH_SECRET) as {
        id: number;
        email: string;
      };
    } catch (error) {
      res.status(401).json({ error: "Invalid or expired refresh token" });
      return;
    }

    // Check if refresh token exists in database and is not revoked
    const storedToken = await prisma.refreshToken.findFirst({
      where: {
        token: refreshToken,
        userId: decoded.id,
        revoked: false,
        expiresAt: {
          gt: new Date(),
        },
      },
    });

    if (!storedToken) {
      res.status(401).json({ error: "Invalid or expired refresh token" });
      return;
    }

    // Generate new access token
    const newAccessToken = generateAccessToken(decoded.id, decoded.email);

    // Generate new refresh token (rotation)
    const newRefreshToken = generateRefreshToken(decoded.id, decoded.email);

    // Revoke old refresh token
    await prisma.refreshToken.update({
      where: { id: storedToken.id },
      data: { revoked: true },
    });

    // Store new refresh token
    await prisma.refreshToken.create({
      data: {
        token: newRefreshToken,
        userId: decoded.id,
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      },
    });

    res.json({
      message: "Token refreshed successfully",
      accessToken: newAccessToken,
      refreshToken: newRefreshToken,
    });
  } catch (error) {
    console.error("Refresh token error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

export const logout = async (req: Request, res: Response): Promise<void> => {
  try {
    const { refreshToken } = req.body;

    if (!refreshToken) {
      res.status(400).json({ error: "Refresh token is required" });
      return;
    }

    // Revoke the refresh token
    await prisma.refreshToken.updateMany({
      where: {
        token: refreshToken,
        revoked: false,
      },
      data: {
        revoked: true,
      },
    });

    res.json({ message: "Logged out successfully" });
  } catch (error) {
    console.error("Logout error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

export const logoutAll = async (req: Request, res: Response): Promise<void> => {
  try {
    const { userId } = req.body;

    if (!userId) {
      res.status(400).json({ error: "User ID is required" });
      return;
    }

    // Revoke all refresh tokens for the user
    await prisma.refreshToken.updateMany({
      where: {
        userId,
        revoked: false,
      },
      data: {
        revoked: true,
      },
    });

    res.json({ message: "Logged out from all devices successfully" });
  } catch (error) {
    console.error("Logout all error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};





// src/config/db.ts
import { PrismaClient } from "@prisma/client";
import dotenv from "dotenv";

dotenv.config();

export const prisma = new PrismaClient({
  log: [
    { emit: "event", level: "query" }, // for slow queries
    { emit: "stdout", level: "error" },
    { emit: "stdout", level: "info" },
  ],
});

// Log slow queries (>100ms)
prisma.$on("query", (e) => {
  if (e.duration > 100) {
    console.log("Slow query detected:", {
      query: e.query,
      params: e.params,
      duration: e.duration,
    });
  }
});

// Initialize database (optional if you use migrations)
export const initDB = async (): Promise<void> => {
  try {
    // Prisma handles tables automatically via migrations or db push
    console.log("‚úÖ Prisma Client is ready to use");
  } catch (error) {
    console.error("‚ùå Database initialization failed:", error);
    throw error;
  }
};

// Graceful shutdown
export const closeDB = async () => {
  await prisma.$disconnect();
  console.log("Database connection closed");
};





{
  "name": "taskaya-backend",
  "version": "1.0.0",
  "description": "Task management API with Prisma and authentication",
  "main": "dist/server.js",
  "scripts": {
    "dev": "concurrently -n \"BACKEND,FRONTEND\" -c \"bgBlue.bold,bgMagenta.bold\" \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "ts-node-dev --respawn --transpile-only src/server.ts",
    "dev:frontend": "cd ../frontend && npm run dev",
    "build": "tsc",
    "start": "concurrently -n \"BACKEND,FRONTEND\" -c \"bgBlue.bold,bgMagenta.bold\" \"npm run start:backend\" \"npm run start:frontend\"",
    "start:backend": "ts-node-dev --respawn --transpile-only src/server.ts",
    "start:frontend": "cd ../frontend && npm run dev",
    "serve": "node dist/server.js",
    "clean": "rm -rf dist",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:migrate:prod": "prisma migrate deploy",
    "prisma:studio": "prisma studio",
    "prisma:seed": "ts-node prisma/seed.ts",
    "prisma:reset": "prisma migrate reset",
    "db:push": "prisma db push",
    "postinstall": "prisma generate"
  },
  "keywords": [
    "express",
    "typescript",
    "prisma",
    "postgresql",
    "api",
    "taskaya"
  ],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@clerk/clerk-sdk-node": "^4.13.23",
    "@prisma/client": "^5.22.0",
    "bcrypt": "^5.1.1",
    "cors": "^2.8.5",
    "dotenv": "^16.6.1",
    "express": "^4.22.1",
    "express-validator": "^7.3.1",
    "jsonwebtoken": "^9.0.3",
    "pg": "^8.16.3"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/jsonwebtoken": "^9.0.6",
    "@types/node": "^20.14.9",
    "concurrently": "^8.2.2",
    "prisma": "^5.22.0",
    "ts-node": "^10.9.2",
    "ts-node-dev": "^2.0.0",
    "typescript": "^5.9.3"
  }
}
